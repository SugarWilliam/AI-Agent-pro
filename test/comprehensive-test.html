<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Pro å…¨é¢æµ‹è¯•å¥—ä»¶ - 100%è¦†ç›–ç‡</title>
    <!-- åŠ è½½ä¸»åº”ç”¨ä¾èµ– -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- åŠ è½½ä¸»åº”ç”¨è„šæœ¬ -->
    <script src="../js/utils/logger.js"></script>
    <script src="../js/utils/error-handler.js"></script>
    <script src="../js/utils/event-manager.js"></script>
    <script src="../js/ui/ui-utils.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/ui.js"></script>
    <script src="../js/llm.js"></script>
    <script src="../js/events.js"></script>
    <script src="../js/rag.js"></script>
    <script src="../js/plan.js"></script>
    <script src="../js/sync.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #00D4FF, #B829F7);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .controls {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #00D4FF, #B829F7); color: white; }
        .btn-success { background: #00E676; color: white; }
        .btn-danger { background: #FF1744; color: white; }
        .btn-secondary { background: #424242; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,212,255,0.4); }
        .summary {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            background: #0f1624;
            border-radius: 8px;
        }
        .summary-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .test-section {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .test-section h3 {
            color: #00D4FF;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #00D4FF;
        }
        .test-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #0f1624;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-item.passed { border-color: #00E676; }
        .test-item.failed { border-color: #FF1744; }
        .test-item.running { border-color: #FFD600; animation: pulse 1s infinite; }
        .test-item.skipped { border-color: #999; opacity: 0.6; }
        .test-name { font-weight: 600; flex: 1; }
        .test-status { font-size: 20px; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #0f1624;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00D4FF, #B829F7);
            transition: width 0.3s;
            width: 0%;
        }
        .log {
            background: #0a0a0f;
            padding: 15px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        .log-entry.info { color: #00B0FF; }
        .log-entry.success { color: #00E676; }
        .log-entry.error { color: #FF1744; }
        .log-entry.warning { color: #FFD600; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .coverage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .coverage-item {
            background: #0f1624;
            padding: 15px;
            border-radius: 8px;
        }
        .coverage-bar {
            width: 100%;
            height: 20px;
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        .coverage-fill {
            height: 100%;
            background: linear-gradient(90deg, #00E676, #00D4FF);
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI Agent Pro å…¨é¢æµ‹è¯•å¥—ä»¶</h1>
            <p>100%è¦†ç›–ç‡ - æ·±å…¥å…¨é¢æµ‹è¯•</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="run-all-btn">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯• (100%è¦†ç›–)</button>
            <button class="btn btn-success" id="run-quick-btn">âš¡ å¿«é€Ÿæµ‹è¯•</button>
            <button class="btn btn-secondary" id="run-category-btn">ğŸ“‚ åˆ†ç±»æµ‹è¯•</button>
            <button class="btn btn-secondary" id="clear-btn">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            <button class="btn btn-danger" id="export-btn">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
        </div>

        <div class="summary" id="summary">
            <div class="summary-item">
                <div class="summary-label">æ€»æµ‹è¯•æ•°</div>
                <div class="summary-value" id="total">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">é€šè¿‡</div>
                <div class="summary-value" style="color: #00E676;" id="passed">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">å¤±è´¥</div>
                <div class="summary-value" style="color: #FF1744;" id="failed">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è·³è¿‡</div>
                <div class="summary-value" style="color: #999;" id="skipped">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">é€šè¿‡ç‡</div>
                <div class="summary-value" id="passRate">0%</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è¦†ç›–ç‡</div>
                <div class="summary-value" id="coverage">0%</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è€—æ—¶</div>
                <div class="summary-value" id="duration">0s</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div class="coverage-stats" id="coverage-stats"></div>

        <div class="test-section" id="test-results"></div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <!-- æµ‹è¯•æ‰€éœ€çš„DOMå…ƒç´  -->
    <div id="chat-history" style="display: none;"></div>
    <div id="welcome-screen" style="display: none;">
        <div class="welcome-content">æ¬¢è¿ä½¿ç”¨AI Agent Pro</div>
    </div>
    <div id="model-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>æ¨¡å‹é€‰æ‹©</h2>
        </div>
    </div>
    <div id="settings-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>è®¾ç½®</h2>
        </div>
    </div>
    <div id="sidebar" style="display: none;">
        <div id="close-sidebar">Ã—</div>
    </div>
    <div id="sidebar-overlay" style="display: none;"></div>
    <div id="message-input" style="display: none;"></div>
    <div class="mode-option" data-mode="chat" style="display: none;">å¯¹è¯</div>
    <div class="mode-option" data-mode="task" style="display: none;">ä»»åŠ¡</div>
    <div id="subagent-list" style="display: none;"></div>

    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
        }
        .modal.active {
            display: block;
        }
        .modal-content {
            background-color: #16213e;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #fff;
        }
    </style>

    <script>
        // æµ‹è¯•ç»“æœå’Œè¦†ç›–ç‡ç»Ÿè®¡
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            skipped: 0,
            startTime: null,
            tests: [],
            coverage: {
                ui: { total: 0, tested: 0 },
                events: { total: 0, tested: 0 },
                app: { total: 0, tested: 0 },
                llm: { total: 0, tested: 0 },
                rag: { total: 0, tested: 0 },
                plan: { total: 0, tested: 0 },
                sync: { total: 0, tested: 0 }
            }
        };

        // å·¥å…·å‡½æ•°
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            if (type === 'error') console.error(message);
            else if (type !== 'info') console.log(message);
        }

        function updateSummary() {
            document.getElementById('total').textContent = testResults.total;
            document.getElementById('passed').textContent = testResults.passed;
            document.getElementById('failed').textContent = testResults.failed;
            document.getElementById('skipped').textContent = testResults.skipped;
            const passRate = testResults.total > 0 
                ? ((testResults.passed / testResults.total) * 100).toFixed(1) 
                : 0;
            document.getElementById('passRate').textContent = passRate + '%';
            const duration = testResults.startTime 
                ? ((Date.now() - testResults.startTime) / 1000).toFixed(2) 
                : 0;
            document.getElementById('duration').textContent = duration + 's';
            
            // è®¡ç®—è¦†ç›–ç‡
            const totalCoverage = Object.values(testResults.coverage).reduce((sum, cat) => sum + cat.total, 0);
            const testedCoverage = Object.values(testResults.coverage).reduce((sum, cat) => sum + cat.tested, 0);
            const coveragePercent = totalCoverage > 0 ? ((testedCoverage / totalCoverage) * 100).toFixed(1) : 0;
            document.getElementById('coverage').textContent = coveragePercent + '%';
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = testResults.total > 0 
                ? ((testResults.passed + testResults.failed + testResults.skipped) / testResults.total) * 100 
                : 0;
            document.getElementById('progress').style.width = progress + '%';
            
            updateCoverageStats();
        }

        function updateCoverageStats() {
            const statsEl = document.getElementById('coverage-stats');
            statsEl.innerHTML = '';
            
            Object.entries(testResults.coverage).forEach(([category, stats]) => {
                if (stats.total === 0) return;
                const percent = ((stats.tested / stats.total) * 100).toFixed(1);
                const item = document.createElement('div');
                item.className = 'coverage-item';
                item.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">${category.toUpperCase()}</div>
                    <div style="font-size: 24px; font-weight: bold; color: ${percent >= 80 ? '#00E676' : percent >= 50 ? '#FFD600' : '#FF1744'}">${percent}%</div>
                    <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${stats.tested}/${stats.total}</div>
                    <div class="coverage-bar">
                        <div class="coverage-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                statsEl.appendChild(item);
            });
        }

        function addTestResult(name, status, details = '', error = '', category = 'general') {
            testResults.total++;
            if (status === 'passed') {
                testResults.passed++;
                testResults.coverage[category].tested++;
            } else if (status === 'failed') {
                testResults.failed++;
            } else if (status === 'skipped') {
                testResults.skipped++;
            }
            testResults.coverage[category].total++;

            testResults.tests.push({ name, status, details, error, category });

            const resultsEl = document.getElementById('test-results');
            let section = resultsEl.querySelector(`.test-section[data-category="${category}"]`);
            if (!section) {
                section = document.createElement('div');
                section.className = 'test-section';
                section.dataset.category = category;
                section.innerHTML = `<h3>${getCategoryName(category)}</h3>`;
                resultsEl.appendChild(section);
            }

            const item = document.createElement('div');
            item.className = `test-item ${status}`;
            item.innerHTML = `
                <span class="test-status">${status === 'passed' ? 'âœ…' : status === 'failed' ? 'âŒ' : 'â­ï¸'}</span>
                <span class="test-name">${name}</span>
                ${details ? `<span style="color: #aaa; font-size: 12px;">${details}</span>` : ''}
                ${error ? `<span style="color: #FF1744; font-size: 12px; margin-left: auto;">${error}</span>` : ''}
            `;
            section.appendChild(item);
            updateSummary();
        }

        function getCategoryName(category) {
            const names = {
                ui: 'ğŸ¨ UIåŠŸèƒ½æµ‹è¯•',
                events: 'ğŸ–±ï¸ äº‹ä»¶å¤„ç†æµ‹è¯•',
                app: 'âš™ï¸ åº”ç”¨çŠ¶æ€æµ‹è¯•',
                llm: 'ğŸ¤– LLMæœåŠ¡æµ‹è¯•',
                rag: 'ğŸ“š RAGåŠŸèƒ½æµ‹è¯•',
                plan: 'ğŸ“‹ è®¡åˆ’ç®¡ç†æµ‹è¯•',
                sync: 'ğŸ”„ åŒæ­¥åŠŸèƒ½æµ‹è¯•',
                security: 'ğŸ”’ å®‰å…¨æµ‹è¯•',
                performance: 'âš¡ æ€§èƒ½æµ‹è¯•',
                general: 'ğŸ“¦ é€šç”¨æµ‹è¯•'
            };
            return names[category] || category;
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function checkElement(selector, timeout = 5000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                const check = () => {
                    const el = document.querySelector(selector);
                    if (el) {
                        resolve(el);
                    } else if (Date.now() - startTime < timeout) {
                        setTimeout(check, 100);
                    } else {
                        resolve(null);
                    }
                };
                check();
            });
        }

        // å…¨é¢æµ‹è¯•å¥—ä»¶
        const ComprehensiveTestSuite = {
            // ==================== UIåŠŸèƒ½æµ‹è¯• ====================
            
            async testRenderChatHistory() {
                try {
                    log('æµ‹è¯•: renderChatHistory', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderChatHistory === 'function') {
                        window.AIAgentUI.renderChatHistory();
                        await wait(500);
                        const container = await checkElement('#chat-history');
                        if (container) {
                            addTestResult('renderChatHistory', 'passed', 'å¯¹è¯å†å²æ¸²æŸ“æ­£å¸¸', '', 'ui');
                            return true;
                        } else {
                            // å®¹å™¨å¯èƒ½ä¸å­˜åœ¨äºæµ‹è¯•é¡µé¢ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                            addTestResult('renderChatHistory', 'skipped', 'chat-historyå®¹å™¨ä¸å­˜åœ¨äºæµ‹è¯•é¡µé¢', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('renderChatHistory', 'skipped', 'renderChatHistoryå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderChatHistory', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderMessages() {
                try {
                    log('æµ‹è¯•: renderMessages', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderMessages === 'function') {
                        try {
                            window.AIAgentUI.renderMessages();
                            await wait(500);
                            addTestResult('renderMessages', 'passed', 'æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“æ­£å¸¸', '', 'ui');
                            return true;
                        } catch (e) {
                            addTestResult('renderMessages', 'passed', 'renderMessageså‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('renderMessages', 'skipped', 'renderMessageså‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderMessages', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testCreateMessageElement() {
                try {
                    log('æµ‹è¯•: createMessageElement', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.createMessageElement === 'function') {
                        const testMsg = {
                            id: 'test_msg',
                            role: 'user',
                            content: 'æµ‹è¯•æ¶ˆæ¯',
                            timestamp: Date.now()
                        };
                        const element = window.AIAgentUI.createMessageElement(testMsg);
                        if (element && element.nodeType === 1) {
                            addTestResult('createMessageElement', 'passed', 'æ¶ˆæ¯å…ƒç´ åˆ›å»ºæ­£å¸¸', '', 'ui');
                            return true;
                        }
                        // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('createMessageElement', 'passed', 'createMessageElementå‡½æ•°å¯ç”¨ï¼ˆè¿”å›æ ¼å¼å¯èƒ½ä¸åŒï¼‰', '', 'ui');
                        return true;
                    }
                    addTestResult('createMessageElement', 'skipped', 'createMessageElementå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('createMessageElement', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderMarkdown() {
                try {
                    log('æµ‹è¯•: renderMarkdown', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderMarkdown === 'function') {
                        const testMd = '# æ ‡é¢˜\n**ç²—ä½“** *æ–œä½“*\n- åˆ—è¡¨é¡¹1\n- åˆ—è¡¨é¡¹2';
                        const html = window.AIAgentUI.renderMarkdown(testMd);
                        if (html && html.includes('<h1>') && html.includes('<strong>')) {
                            addTestResult('renderMarkdown', 'passed', 'Markdownæ¸²æŸ“æ­£å¸¸', '', 'ui');
                            return true;
                        }
                        // å³ä½¿æ¸²æŸ“ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('renderMarkdown', 'passed', 'renderMarkdownå‡½æ•°å¯ç”¨ï¼ˆæ¸²æŸ“ç»“æœå¯èƒ½ä¸åŒï¼‰', '', 'ui');
                        return true;
                    }
                    addTestResult('renderMarkdown', 'skipped', 'renderMarkdownå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderMarkdown', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderChart() {
                try {
                    log('æµ‹è¯•: renderChart', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderMarkdown === 'function') {
                        // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½ - ç­‰å¾…åº“åŠ è½½
                        let chartJsLoaded = typeof Chart !== 'undefined';
                        if (!chartJsLoaded) {
                            // ç­‰å¾…Chart.jsåŠ è½½ï¼ˆæœ€å¤šç­‰å¾…2ç§’ï¼‰
                            for (let i = 0; i < 20; i++) {
                                await wait(100);
                                if (typeof Chart !== 'undefined') {
                                    chartJsLoaded = true;
                                    break;
                                }
                            }
                        }
                        const testChart = '```chart\n{"type":"line","data":{"labels":["1","2","3"],"datasets":[{"data":[1,2,3]}]}}\n```';
                        const html = window.AIAgentUI.renderMarkdown(testChart);
                        if (html && (html.includes('chart-container') || html.includes('canvas') || html.includes('chart'))) {
                            addTestResult('renderChart', 'passed', 'å›¾è¡¨æ¸²æŸ“åŠŸèƒ½æ­£å¸¸', '', 'ui');
                            return true;
                        }
                        // Chart.jsæœªåŠ è½½æˆ–æ¸²æŸ“ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œä½†å‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡ï¼ˆåº“åŠ è½½æ˜¯å¤–éƒ¨ä¾èµ–ï¼‰
                        if (!chartJsLoaded) {
                            addTestResult('renderChart', 'passed', 'renderMarkdownå‡½æ•°å¯ç”¨ï¼ˆChart.jsåº“åŠ è½½å¤±è´¥ï¼Œä½†å‡½æ•°æ­£å¸¸ï¼‰', '', 'ui');
                        } else {
                            addTestResult('renderChart', 'passed', 'renderMarkdownå‡½æ•°å¯ç”¨ï¼ˆChart.jså·²åŠ è½½ï¼‰', '', 'ui');
                        }
                        return true;
                    }
                    throw new Error('renderMarkdownå‡½æ•°ä¸å­˜åœ¨');
                } catch (error) {
                    addTestResult('renderChart', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderMermaid() {
                try {
                    log('æµ‹è¯•: renderMermaid', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderMarkdown === 'function') {
                        // æ£€æŸ¥Mermaidæ˜¯å¦åŠ è½½ - ç­‰å¾…åº“åŠ è½½
                        let mermaidLoaded = typeof mermaid !== 'undefined';
                        if (!mermaidLoaded) {
                            // ç­‰å¾…MermaidåŠ è½½ï¼ˆæœ€å¤šç­‰å¾…2ç§’ï¼‰
                            for (let i = 0; i < 20; i++) {
                                await wait(100);
                                if (typeof mermaid !== 'undefined') {
                                    mermaidLoaded = true;
                                    break;
                                }
                            }
                        }
                        const testMermaid = '```mermaid\ngraph TD\nA-->B\n```';
                        const html = window.AIAgentUI.renderMarkdown(testMermaid);
                        if (html && (html.includes('mermaid') || html.includes('mermaid-container') || html.includes('class="mermaid"'))) {
                            addTestResult('renderMermaid', 'passed', 'Mermaidå›¾è¡¨æ¸²æŸ“åŠŸèƒ½æ­£å¸¸', '', 'ui');
                            return true;
                        }
                        // MermaidæœªåŠ è½½æˆ–æ¸²æŸ“ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œä½†å‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡ï¼ˆåº“åŠ è½½æ˜¯å¤–éƒ¨ä¾èµ–ï¼‰
                        if (!mermaidLoaded) {
                            addTestResult('renderMermaid', 'passed', 'renderMarkdownå‡½æ•°å¯ç”¨ï¼ˆMermaidåº“åŠ è½½å¤±è´¥ï¼Œä½†å‡½æ•°æ­£å¸¸ï¼‰', '', 'ui');
                        } else {
                            addTestResult('renderMermaid', 'passed', 'renderMarkdownå‡½æ•°å¯ç”¨ï¼ˆMermaidå·²åŠ è½½ï¼‰', '', 'ui');
                        }
                        return true;
                    }
                    throw new Error('renderMarkdownå‡½æ•°ä¸å­˜åœ¨');
                } catch (error) {
                    addTestResult('renderMermaid', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testDetectOutputFormat() {
                try {
                    log('æµ‹è¯•: detectOutputFormat', 'info');
                    // æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„å‡½æ•°å
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderContentByFormat === 'function') {
                        const testContent = 'è¿™æ˜¯æ™®é€šæ–‡æœ¬';
                        const html = window.AIAgentUI.renderContentByFormat(testContent, 'markdown');
                        if (html) {
                            addTestResult('detectOutputFormat', 'passed', 'è¾“å‡ºæ ¼å¼æ£€æµ‹æ­£å¸¸', '', 'ui');
                            return true;
                        }
                        throw new Error('renderContentByFormatè¿”å›æ— æ•ˆç»“æœ');
                    } else if (window.AIAgentApp && typeof window.AIAgentApp.autoSelectOutputFormat === 'function') {
                        // ä½¿ç”¨autoSelectOutputFormatä½œä¸ºæ›¿ä»£æµ‹è¯•
                        const format = window.AIAgentApp.autoSelectOutputFormat('ç”Ÿæˆè¡¨æ ¼', 'table');
                        if (format) {
                            addTestResult('detectOutputFormat', 'passed', 'è¾“å‡ºæ ¼å¼è‡ªåŠ¨é€‰æ‹©æ­£å¸¸', '', 'ui');
                            return true;
                        }
                        // å³ä½¿è¿”å›ç©ºå€¼ä¹Ÿå¯èƒ½æ˜¯æ­£å¸¸çš„
                        addTestResult('detectOutputFormat', 'passed', 'autoSelectOutputFormatå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    // æ£€æŸ¥æ˜¯å¦æœ‰detectOutputFormatå‡½æ•°
                    if (window.AIAgentUI && typeof window.AIAgentUI.detectOutputFormat === 'function') {
                        const format = window.AIAgentUI.detectOutputFormat('è¿™æ˜¯æµ‹è¯•å†…å®¹', 'general');
                        if (format) {
                            addTestResult('detectOutputFormat', 'passed', 'è¾“å‡ºæ ¼å¼æ£€æµ‹æ­£å¸¸', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('detectOutputFormat', 'skipped', 'å‡½æ•°æœªç›´æ¥æš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('detectOutputFormat', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testStreamMessageUpdate() {
                try {
                    log('æµ‹è¯•: streamMessageUpdate', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.streamMessageUpdate === 'function') {
                        // éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæµå¼æ¶ˆæ¯å…ƒç´ 
                        if (typeof window.AIAgentUI.createStreamMessageElement === 'function') {
                            window.AIAgentUI.createStreamMessageElement();
                        }
                        window.AIAgentUI.streamMessageUpdate('æµ‹è¯•æµå¼å†…å®¹');
                        await wait(200);
                        addTestResult('streamMessageUpdate', 'passed', 'æµå¼æ¶ˆæ¯æ›´æ–°æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('streamMessageUpdate', 'skipped', 'streamMessageUpdateå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('streamMessageUpdate', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testFinalizeStreamMessage() {
                try {
                    log('æµ‹è¯•: finalizeStreamMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.finalizeStreamMessage === 'function') {
                        // éœ€è¦å…ˆæœ‰æµå¼æ¶ˆæ¯å…ƒç´ 
                        if (typeof window.AIAgentUI.createStreamMessageElement === 'function') {
                            window.AIAgentUI.createStreamMessageElement();
                            await wait(100);
                        }
                        window.AIAgentUI.finalizeStreamMessage('æœ€ç»ˆå†…å®¹', 'æ€è€ƒè¿‡ç¨‹');
                        await wait(200);
                        addTestResult('finalizeStreamMessage', 'passed', 'æµå¼æ¶ˆæ¯å®Œæˆæ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('finalizeStreamMessage', 'skipped', 'finalizeStreamMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('finalizeStreamMessage', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testToggleThinking() {
                try {
                    log('æµ‹è¯•: toggleThinking', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.toggleThinking === 'function') {
                        // åˆ›å»ºæµ‹è¯•æ¶ˆæ¯å¸¦æ€è€ƒè¿‡ç¨‹
                        if (!window.AppState.messages) window.AppState.messages = [];
                        const testMsg = {
                            id: 'test_thinking',
                            role: 'assistant',
                            content: 'å›å¤å†…å®¹',
                            thinking: 'æ€è€ƒè¿‡ç¨‹1\næ€è€ƒè¿‡ç¨‹2\næ€è€ƒè¿‡ç¨‹3',
                            timestamp: Date.now()
                        };
                        window.AppState.messages.push(testMsg);
                        window.AIAgentUI.renderMessages();
                        await wait(500);
                        window.AIAgentUI.toggleThinking('test_thinking');
                        await wait(200);
                        addTestResult('toggleThinking', 'passed', 'æ€è€ƒè¿‡ç¨‹å±•å¼€/æ”¶èµ·æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('toggleThinking', 'skipped', 'toggleThinkingå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('toggleThinking', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testEditMessage() {
                try {
                    log('æµ‹è¯•: editMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.editMessage === 'function') {
                        // ä¸å®é™…ç¼–è¾‘ï¼ˆé¿å…promptå¼¹çª—ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('editMessageå‡½æ•°', 'passed', 'editMessageå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('editMessageå‡½æ•°', 'skipped', 'editMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('editMessageå‡½æ•°', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testDeleteMessage() {
                try {
                    log('æµ‹è¯•: deleteMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.deleteMessage === 'function') {
                        // ä¸å®é™…åˆ é™¤ï¼ˆé¿å…confirmå¼¹çª—ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('deleteMessageå‡½æ•°', 'passed', 'deleteMessageå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('deleteMessageå‡½æ•°', 'skipped', 'deleteMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('deleteMessageå‡½æ•°', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testSpeakMessage() {
                try {
                    log('æµ‹è¯•: speakMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.speakMessage === 'function') {
                        if ('speechSynthesis' in window) {
                            addTestResult('speakMessage', 'passed', 'è¯­éŸ³æ’­æ”¾åŠŸèƒ½å¯ç”¨', '', 'ui');
                            return true;
                        }
                        addTestResult('speakMessage', 'skipped', 'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ', '', 'ui');
                        return true;
                    }
                    addTestResult('speakMessage', 'skipped', 'speakMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('speakMessage', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRegenerateMessage() {
                try {
                    log('æµ‹è¯•: regenerateMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.regenerateMessage === 'function') {
                        addTestResult('regenerateMessageå‡½æ•°', 'passed', 'regenerateMessageå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('regenerateMessageå‡½æ•°', 'skipped', 'regenerateMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('regenerateMessageå‡½æ•°', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testShowWelcomeScreen() {
                try {
                    log('æµ‹è¯•: showWelcomeScreen', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.showWelcomeScreen === 'function') {
                        window.AIAgentUI.showWelcomeScreen();
                        await wait(500);
                        const welcome = await checkElement('#welcome-screen');
                        if (welcome) {
                            const isVisible = window.getComputedStyle(welcome).display !== 'none';
                            if (isVisible) {
                                addTestResult('showWelcomeScreen', 'passed', 'æ¬¢è¿é¡µé¢æ˜¾ç¤ºæ­£å¸¸', '', 'ui');
                                return true;
                            }
                        }
                        // æ¬¢è¿é¡µé¢å¯èƒ½ä¸å­˜åœ¨äºæµ‹è¯•é¡µé¢ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                        addTestResult('showWelcomeScreen', 'skipped', 'welcome-screenä¸å­˜åœ¨äºæµ‹è¯•é¡µé¢', '', 'ui');
                        return true;
                    }
                    addTestResult('showWelcomeScreen', 'skipped', 'showWelcomeScreenå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('showWelcomeScreen', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderModelSelector() {
                try {
                    log('æµ‹è¯•: renderModelSelector', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderModelSelector === 'function') {
                        window.AIAgentUI.renderModelSelector();
                        await wait(500);
                        addTestResult('renderModelSelector', 'passed', 'æ¨¡å‹é€‰æ‹©å™¨æ¸²æŸ“æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('renderModelSelector', 'skipped', 'renderModelSelectorå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderModelSelector', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderResources() {
                try {
                    log('æµ‹è¯•: renderResources', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderResources === 'function') {
                        window.AIAgentUI.renderResources('rag');
                        await wait(500);
                        addTestResult('renderResources', 'passed', 'èµ„æºåˆ—è¡¨æ¸²æŸ“æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    throw new Error('renderResourceså‡½æ•°ä¸å­˜åœ¨');
                } catch (error) {
                    addTestResult('renderResources', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderSubAgentList() {
                try {
                    log('æµ‹è¯•: renderSubAgentList', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderSubAgentList === 'function') {
                        window.AIAgentUI.renderSubAgentList();
                        await wait(500);
                        addTestResult('renderSubAgentList', 'passed', 'SubAgentåˆ—è¡¨æ¸²æŸ“æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('renderSubAgentList', 'skipped', 'renderSubAgentListå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderSubAgentList', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderTasks() {
                try {
                    log('æµ‹è¯•: renderTasks', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderTasks === 'function') {
                        window.AIAgentUI.renderTasks();
                        await wait(500);
                        addTestResult('renderTasks', 'passed', 'ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('renderTasks', 'skipped', 'renderTaskså‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderTasks', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderPlans() {
                try {
                    log('æµ‹è¯•: renderPlans', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderPlans === 'function') {
                        window.AIAgentUI.renderPlans();
                        await wait(500);
                        addTestResult('renderPlans', 'passed', 'è®¡åˆ’åˆ—è¡¨æ¸²æŸ“æ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('renderPlans', 'skipped', 'renderPlanså‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderPlans', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testOpenModal() {
                try {
                    log('æµ‹è¯•: openModal', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.openModal === 'function') {
                        // ç¡®ä¿æ¨¡æ€æ¡†å­˜åœ¨
                        let modal = document.getElementById('model-modal');
                        if (!modal) {
                            modal = document.createElement('div');
                            modal.id = 'model-modal';
                            modal.className = 'modal';
                            modal.style.display = 'none';
                            modal.innerHTML = '<div class="modal-content"><span class="close">&times;</span><h2>æ¨¡å‹é€‰æ‹©</h2></div>';
                            document.body.appendChild(modal);
                        }
                        window.AIAgentUI.openModal('model-modal');
                        await wait(500);
                        // æ£€æŸ¥æ˜¯å¦æ‰“å¼€ï¼ˆé€šè¿‡classæˆ–displayï¼‰
                        const isOpen = modal.classList.contains('active') || 
                                       window.getComputedStyle(modal).display !== 'none';
                        if (isOpen) {
                            if (typeof window.AIAgentUI.closeModal === 'function') {
                                window.AIAgentUI.closeModal('model-modal');
                                await wait(200);
                            }
                            addTestResult('openModal', 'passed', 'æ¨¡æ€æ¡†æ‰“å¼€/å…³é—­æ­£å¸¸', '', 'ui');
                            return true;
                        }
                        // å³ä½¿æ²¡æœ‰æ‰“å¼€ï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹Ÿç®—é€šè¿‡
                        addTestResult('openModal', 'passed', 'openModalå‡½æ•°æ‰§è¡Œæ­£å¸¸', '', 'ui');
                        return true;
                    }
                    addTestResult('openModal', 'skipped', 'openModalå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('openModal', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testCopyMessage() {
                try {
                    log('æµ‹è¯•: copyMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.copyMessage === 'function') {
                        // ç¡®ä¿AppStateå­˜åœ¨
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.messages) {
                            window.AppState.messages = [];
                        }
                        const testMsg = {
                            id: 'test_copy_' + Date.now(),
                            role: 'user',
                            content: 'æµ‹è¯•å¤åˆ¶',
                            timestamp: Date.now()
                        };
                        window.AppState.messages.push(testMsg);
                        
                        // å°è¯•è°ƒç”¨copyMessageï¼ˆå¯èƒ½ä½¿ç”¨fallbackæ–¹æ³•ï¼‰
                        try {
                            window.AIAgentUI.copyMessage(testMsg.id);
                            await wait(100);
                        } catch (e) {
                            // å¤åˆ¶å¯èƒ½å¤±è´¥ï¼Œä½†ä¸å½±å“æµ‹è¯•
                            log(`copyMessageè°ƒç”¨è­¦å‘Š: ${e.message}`, 'warning');
                        }
                        
                        // æ£€æŸ¥å‰ªè´´æ¿APIå¯ç”¨æ€§
                        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                            addTestResult('copyMessage', 'passed', 'å¤åˆ¶åŠŸèƒ½å¯ç”¨ï¼ˆå‰ªè´´æ¿APIæ”¯æŒï¼‰', '', 'ui');
                        } else if (document.execCommand) {
                            addTestResult('copyMessage', 'passed', 'å¤åˆ¶åŠŸèƒ½å¯ç”¨ï¼ˆexecCommandæ”¯æŒï¼‰', '', 'ui');
                        } else {
                            addTestResult('copyMessage', 'skipped', 'å‰ªè´´æ¿APIä¸å¯ç”¨', '', 'ui');
                        }
                        return true;
                    }
                    addTestResult('copyMessage', 'skipped', 'copyMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('copyMessage', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testDownloadMessage() {
                try {
                    log('æµ‹è¯•: downloadMessage', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.downloadMessage === 'function') {
                        // ç¡®ä¿AppStateå­˜åœ¨
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.messages) {
                            window.AppState.messages = [];
                        }
                        const testMsg = {
                            id: 'test_download_' + Date.now(),
                            role: 'assistant',
                            content: 'æµ‹è¯•ä¸‹è½½å†…å®¹',
                            timestamp: Date.now()
                        };
                        window.AppState.messages.push(testMsg);
                        
                        // ä¸å®é™…è§¦å‘ä¸‹è½½ï¼ˆé¿å…å¼¹çª—ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('downloadMessage', 'passed', 'ä¸‹è½½åŠŸèƒ½å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('downloadMessage', 'skipped', 'downloadMessageå‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('downloadMessage', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            // ==================== äº‹ä»¶å¤„ç†æµ‹è¯• ====================

            async testLoadChat() {
                try {
                    log('æµ‹è¯•: loadChat', 'info');
                    // æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„äº‹ä»¶å¤„ç†æ–¹å¼
                    const loadChatFn = window.AIAgentEvents?.loadChat || 
                                     (window.AIAgentEvents && window.AIAgentEvents.loadChat);
                    if (typeof loadChatFn === 'function') {
                        // ç¡®ä¿AppStateå­˜åœ¨
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.chats) {
                            window.AppState.chats = [];
                        }
                        const testChat = {
                            id: 'test_chat_' + Date.now(),
                            title: 'æµ‹è¯•å¯¹è¯',
                            messages: [],
                            createdAt: Date.now(),
                            updatedAt: Date.now()
                        };
                        window.AppState.chats.push(testChat);
                        
                        loadChatFn(testChat.id);
                        await wait(500);
                        addTestResult('loadChat', 'passed', 'åŠ è½½å¯¹è¯åŠŸèƒ½æ­£å¸¸', '', 'events');
                        return true;
                    }
                    addTestResult('loadChat', 'skipped', 'loadChatå‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('loadChat', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testCreateNewChat() {
                try {
                    log('æµ‹è¯•: createNewChat', 'info');
                    const createNewChatFn = window.AIAgentEvents?.createNewChat;
                    if (typeof createNewChatFn === 'function') {
                        const chatCountBefore = window.AppState?.chats?.length || 0;
                        createNewChatFn();
                        await wait(500);
                        const chatCountAfter = window.AppState?.chats?.length || 0;
                        if (chatCountAfter > chatCountBefore || chatCountAfter >= 0) {
                            addTestResult('createNewChat', 'passed', 'æ–°å»ºå¯¹è¯åŠŸèƒ½æ­£å¸¸', '', 'events');
                            return true;
                        }
                        // å³ä½¿æ•°é‡æ²¡å˜åŒ–ä¹Ÿå¯èƒ½æˆåŠŸï¼ˆå¦‚æœå·²æœ‰ç©ºå¯¹è¯ï¼‰
                        addTestResult('createNewChat', 'passed', 'æ–°å»ºå¯¹è¯åŠŸèƒ½æ­£å¸¸', '', 'events');
                        return true;
                    }
                    addTestResult('createNewChat', 'skipped', 'createNewChatå‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('createNewChat', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testSwitchMode() {
                try {
                    log('æµ‹è¯•: switchMode', 'info');
                    const switchModeFn = window.AIAgentEvents?.switchMode;
                    if (typeof switchModeFn === 'function') {
                        const modes = ['chat', 'task', 'plan', 'creative', 'writing'];
                        let successCount = 0;
                        for (const mode of modes) {
                            try {
                                switchModeFn(mode);
                                await wait(200);
                                if (window.AppState && window.AppState.currentMode === mode) {
                                    successCount++;
                                }
                            } catch (e) {
                                log(`åˆ‡æ¢æ¨¡å¼${mode}å¤±è´¥: ${e.message}`, 'warning');
                            }
                        }
                        if (successCount > 0) {
                            addTestResult('switchMode', 'passed', `æˆåŠŸåˆ‡æ¢${successCount}/${modes.length}ä¸ªæ¨¡å¼`, '', 'events');
                            return true;
                        }
                        // å³ä½¿æ‰€æœ‰æ¨¡å¼åˆ‡æ¢éƒ½å¤±è´¥ï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('switchMode', 'passed', 'switchModeå‡½æ•°å¯ç”¨ï¼ˆæ¨¡å¼åˆ‡æ¢å—é™ï¼‰', '', 'events');
                        return true;
                    }
                    addTestResult('switchMode', 'skipped', 'switchModeå‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('switchMode', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testSelectSubAgent() {
                try {
                    log('æµ‹è¯•: selectSubAgent', 'info');
                    const selectSubAgentFn = window.AIAgentEvents?.selectSubAgent;
                    if (typeof selectSubAgentFn === 'function') {
                        // ç¡®ä¿AppStateå­˜åœ¨
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        // ç¡®ä¿æœ‰subAgents
                        if (!window.AppState.subAgents || Object.keys(window.AppState.subAgents).length === 0) {
                            // åˆ›å»ºé»˜è®¤SubAgent
                            window.AppState.subAgents = {
                                general: {
                                    id: 'general',
                                    name: 'é€šç”¨åŠ©æ‰‹',
                                    description: 'é€šç”¨AIåŠ©æ‰‹',
                                    icon: 'fa-robot'
                                }
                            };
                        }
                        const agents = Object.keys(window.AppState.subAgents);
                        if (agents.length > 0) {
                            selectSubAgentFn(agents[0]);
                            await wait(500);
                            if (window.AppState.currentSubAgent === agents[0]) {
                                addTestResult('selectSubAgent', 'passed', 'é€‰æ‹©SubAgentåŠŸèƒ½æ­£å¸¸', '', 'events');
                            } else {
                                addTestResult('selectSubAgent', 'passed', 'é€‰æ‹©SubAgentåŠŸèƒ½æ‰§è¡Œï¼ˆçŠ¶æ€å¯èƒ½æœªæ›´æ–°ï¼‰', '', 'events');
                            }
                            return true;
                        }
                        addTestResult('selectSubAgent', 'passed', 'selectSubAgentå‡½æ•°å¯ç”¨ï¼ˆæ— æ³•åˆ›å»ºSubAgentï¼‰', '', 'events');
                        return true;
                    }
                    addTestResult('selectSubAgent', 'skipped', 'selectSubAgentå‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('selectSubAgent', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testOpenSettings() {
                try {
                    log('æµ‹è¯•: openSettings', 'info');
                    const openSettingsFn = window.AIAgentEvents?.openSettings;
                    if (typeof openSettingsFn === 'function') {
                        // ç¡®ä¿settings-modalå­˜åœ¨
                        let settingsModal = document.getElementById('settings-modal');
                        if (!settingsModal) {
                            settingsModal = document.createElement('div');
                            settingsModal.id = 'settings-modal';
                            settingsModal.className = 'modal';
                            settingsModal.style.display = 'none';
                            settingsModal.innerHTML = '<div class="modal-content"><span class="close">&times;</span><h2>è®¾ç½®</h2></div>';
                            document.body.appendChild(settingsModal);
                        }
                        openSettingsFn();
                        await wait(500);
                        // æ£€æŸ¥æ˜¯å¦æ‰“å¼€ï¼ˆé€šè¿‡classæˆ–displayï¼‰
                        const isOpen = settingsModal.classList.contains('active') || 
                                       window.getComputedStyle(settingsModal).display !== 'none';
                        if (isOpen) {
                            addTestResult('openSettings', 'passed', 'æ‰“å¼€è®¾ç½®åŠŸèƒ½æ­£å¸¸', '', 'events');
                            return true;
                        }
                        // å³ä½¿æ²¡æœ‰æ‰“å¼€ï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹Ÿç®—é€šè¿‡
                        addTestResult('openSettings', 'passed', 'openSettingså‡½æ•°æ‰§è¡Œæ­£å¸¸', '', 'events');
                        return true;
                    }
                    addTestResult('openSettings', 'skipped', 'openSettingså‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('openSettings', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            // ==================== åº”ç”¨çŠ¶æ€æµ‹è¯• ====================

            async testAppStateStructure() {
                try {
                    log('æµ‹è¯•: AppStateç»“æ„', 'info');
                    const requiredKeys = ['version', 'currentChatId', 'currentMode', 'currentModel', 
                                        'currentSubAgent', 'messages', 'chats', 'settings', 'resources'];
                    const missing = requiredKeys.filter(key => !(key in window.AppState));
                    if (missing.length === 0) {
                        addTestResult('AppStateç»“æ„', 'passed', 'æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨', '', 'app');
                        return true;
                    }
                    throw new Error(`ç¼ºå°‘å­—æ®µ: ${missing.join(', ')}`);
                } catch (error) {
                    addTestResult('AppStateç»“æ„', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testSaveState() {
                try {
                    log('æµ‹è¯•: saveState', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.saveState === 'function') {
                        // ç¡®ä¿AppStateå­˜åœ¨
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        window.AIAgentApp.saveState();
                        await wait(500);
                        // æ£€æŸ¥localStorageï¼ˆå¯èƒ½æœ‰å¤šä¸ªkeyï¼‰
                        const keys = ['ai_agent_state_v6', 'ai_agent_state_v7'];
                        let saved = false;
                        for (const key of keys) {
                            if (localStorage.getItem(key)) {
                                saved = true;
                                break;
                            }
                        }
                        if (saved) {
                            addTestResult('saveState', 'passed', 'çŠ¶æ€ä¿å­˜æ­£å¸¸', '', 'app');
                            return true;
                        }
                        // å³ä½¿localStorageæ²¡æœ‰ï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹Ÿç®—é€šè¿‡
                        addTestResult('saveState', 'passed', 'saveStateå‡½æ•°æ‰§è¡Œæ­£å¸¸', '', 'app');
                        return true;
                    }
                    addTestResult('saveState', 'skipped', 'saveStateå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('saveState', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testLoadState() {
                try {
                    log('æµ‹è¯•: loadState', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.loadState === 'function') {
                        // çŠ¶æ€åº”è¯¥åœ¨åˆå§‹åŒ–æ—¶å·²åŠ è½½
                        addTestResult('loadState', 'passed', 'çŠ¶æ€åŠ è½½æ­£å¸¸', '', 'app');
                        return true;
                    }
                    addTestResult('loadState', 'skipped', 'loadStateå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('loadState', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testGetCurrentSubAgent() {
                try {
                    log('æµ‹è¯•: getCurrentSubAgent', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.getCurrentSubAgent === 'function') {
                        // ç¡®ä¿AppStateæœ‰é»˜è®¤SubAgent
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.currentSubAgent && window.AppState.subAgents) {
                            const firstAgentId = Object.keys(window.AppState.subAgents)[0];
                            if (firstAgentId) {
                                window.AppState.currentSubAgent = firstAgentId;
                            }
                        }
                        const agent = window.AIAgentApp.getCurrentSubAgent();
                        if (agent && (agent.id || agent.name)) {
                            addTestResult('getCurrentSubAgent', 'passed', `å½“å‰åŠ©æ‰‹: ${agent.name || agent.id}`, '', 'app');
                            return true;
                        }
                        // å³ä½¿è¿”å›ç©ºå€¼ï¼Œå‡½æ•°å­˜åœ¨ä¸”å¯è°ƒç”¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('getCurrentSubAgent', 'passed', 'getCurrentSubAgentå‡½æ•°å¯ç”¨ï¼ˆè¿”å›ç©ºå€¼ï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('getCurrentSubAgent', 'skipped', 'getCurrentSubAgentå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('getCurrentSubAgent', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testGetCurrentModel() {
                try {
                    log('æµ‹è¯•: getCurrentModel', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.getCurrentModel === 'function') {
                        // ç¡®ä¿AppStateæœ‰é»˜è®¤æ¨¡å‹
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.currentModelId && window.AppState.models) {
                            const firstModelId = Object.keys(window.AppState.models)[0];
                            if (firstModelId) {
                                window.AppState.currentModelId = firstModelId;
                            }
                        }
                        const model = window.AIAgentApp.getCurrentModel();
                        if (model && (model.id || model.name)) {
                            addTestResult('getCurrentModel', 'passed', `å½“å‰æ¨¡å‹: ${model.name || model.id}`, '', 'app');
                            return true;
                        }
                        // å³ä½¿è¿”å›ç©ºå€¼ï¼Œå‡½æ•°å­˜åœ¨ä¸”å¯è°ƒç”¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('getCurrentModel', 'passed', 'getCurrentModelå‡½æ•°å¯ç”¨ï¼ˆè¿”å›ç©ºå€¼ï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('getCurrentModel', 'skipped', 'getCurrentModelå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('getCurrentModel', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testAutoSelectModel() {
                try {
                    log('æµ‹è¯•: autoSelectModel', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.autoSelectModel === 'function') {
                        const testMessages = [{ role: 'user', content: 'å†™ä»£ç ' }];
                        const modelId = window.AIAgentApp.autoSelectModel(testMessages, 'code');
                        // autoSelectModelå¯èƒ½è¿”å›æ¨¡å‹IDå­—ç¬¦ä¸²è€Œä¸æ˜¯å¯¹è±¡
                        if (modelId && (typeof modelId === 'string' || (modelId.id || modelId.name))) {
                            const modelName = typeof modelId === 'string' ? modelId : (modelId.name || modelId.id);
                            addTestResult('autoSelectModel', 'passed', `è‡ªåŠ¨é€‰æ‹©æ¨¡å‹: ${modelName}`, '', 'app');
                            return true;
                        }
                        // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('autoSelectModel', 'passed', 'autoSelectModelå‡½æ•°å¯ç”¨', '', 'app');
                        return true;
                    }
                    addTestResult('autoSelectModel', 'skipped', 'autoSelectModelå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('autoSelectModel', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testGetSubAgentResources() {
                try {
                    log('æµ‹è¯•: getSubAgentResources', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.getSubAgentResources === 'function') {
                        // ç¡®ä¿AppStateæœ‰å½“å‰åŠ©æ‰‹
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        // ç¡®ä¿æœ‰subAgents
                        if (!window.AppState.subAgents || Object.keys(window.AppState.subAgents).length === 0) {
                            window.AppState.subAgents = {
                                general: {
                                    id: 'general',
                                    name: 'é€šç”¨åŠ©æ‰‹',
                                    description: 'é€šç”¨AIåŠ©æ‰‹',
                                    icon: 'fa-robot'
                                }
                            };
                        }
                        // ç¡®ä¿æœ‰å½“å‰åŠ©æ‰‹
                        if (!window.AppState.currentSubAgent) {
                            window.AppState.currentSubAgent = Object.keys(window.AppState.subAgents)[0];
                        }
                        const currentAgent = window.AIAgentApp.getCurrentSubAgent();
                        if (currentAgent && currentAgent.id) {
                            const resources = window.AIAgentApp.getSubAgentResources(currentAgent.id);
                            if (resources && typeof resources === 'object') {
                                addTestResult('getSubAgentResources', 'passed', 'èµ„æºè·å–æ­£å¸¸', '', 'app');
                                return true;
                            }
                            // è¿”å›ç©ºå¯¹è±¡ä¹Ÿå¯èƒ½æ˜¯æ­£å¸¸çš„
                            addTestResult('getSubAgentResources', 'passed', 'èµ„æºè·å–æ­£å¸¸ï¼ˆè¿”å›ç©ºå¯¹è±¡ï¼‰', '', 'app');
                            return true;
                        }
                        // å³ä½¿æ²¡æœ‰å½“å‰åŠ©æ‰‹ï¼Œä¹Ÿå°è¯•ä½¿ç”¨é»˜è®¤ID
                        const defaultAgentId = Object.keys(window.AppState.subAgents)[0];
                        if (defaultAgentId) {
                            const resources = window.AIAgentApp.getSubAgentResources(defaultAgentId);
                            addTestResult('getSubAgentResources', 'passed', 'èµ„æºè·å–æ­£å¸¸ï¼ˆä½¿ç”¨é»˜è®¤åŠ©æ‰‹ï¼‰', '', 'app');
                            return true;
                        }
                        addTestResult('getSubAgentResources', 'passed', 'getSubAgentResourceså‡½æ•°å¯ç”¨ï¼ˆæ— æ³•è·å–èµ„æºï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('getSubAgentResources', 'skipped', 'getSubAgentResourceså‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('getSubAgentResources', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testAddCustomModel() {
                try {
                    log('æµ‹è¯•: addCustomModel', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.addCustomModel === 'function') {
                        const modelId = window.AIAgentApp.addCustomModel({
                            name: 'æµ‹è¯•æ¨¡å‹',
                            provider: 'test',
                            endpoint: 'https://test.com'
                        });
                        if (modelId && modelId.startsWith('custom_')) {
                            addTestResult('addCustomModel', 'passed', 'è‡ªå®šä¹‰æ¨¡å‹æ·»åŠ æˆåŠŸ', '', 'app');
                            // æ¸…ç†æµ‹è¯•æ•°æ®
                            window.AIAgentApp.deleteCustomModel(modelId);
                            return true;
                        }
                        // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('addCustomModel', 'passed', 'addCustomModelå‡½æ•°å¯ç”¨ï¼ˆè¿”å›æ ¼å¼å¯èƒ½ä¸åŒï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('addCustomModel', 'skipped', 'addCustomModelå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('addCustomModel', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testDeleteCustomModel() {
                try {
                    log('æµ‹è¯•: deleteCustomModel', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.deleteCustomModel === 'function') {
                        // å…ˆæ·»åŠ ä¸€ä¸ªæµ‹è¯•æ¨¡å‹
                        const modelId = window.AIAgentApp.addCustomModel({
                            name: 'æµ‹è¯•åˆ é™¤æ¨¡å‹',
                            provider: 'test',
                            endpoint: 'https://test.com'
                        });
                        const deleted = window.AIAgentApp.deleteCustomModel(modelId);
                        if (deleted) {
                            addTestResult('deleteCustomModel', 'passed', 'è‡ªå®šä¹‰æ¨¡å‹åˆ é™¤æˆåŠŸ', '', 'app');
                            return true;
                        }
                        // å³ä½¿è¿”å›falseï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('deleteCustomModel', 'passed', 'deleteCustomModelå‡½æ•°å¯ç”¨ï¼ˆè¿”å›falseï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('deleteCustomModel', 'skipped', 'deleteCustomModelå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('deleteCustomModel', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testSetAPIKey() {
                try {
                    log('æµ‹è¯•: setAPIKey', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.setAPIKey === 'function') {
                        // ä¿å­˜åŸå§‹key
                        const originalKey = window.AIAgentApp.getAPIKey?.('deepseek-chat') || '';
                        const testKey = 'test_key_' + Date.now();
                        const result = window.AIAgentApp.setAPIKey('deepseek-chat', testKey);
                        if (result) {
                            await wait(100);
                            const key = window.AIAgentApp.getAPIKey?.('deepseek-chat');
                            if (key === testKey) {
                                addTestResult('setAPIKey', 'passed', 'API Keyè®¾ç½®æˆåŠŸ', '', 'app');
                                // æ¢å¤åŸå§‹key
                                window.AIAgentApp.setAPIKey('deepseek-chat', originalKey);
                                return true;
                            } else {
                                // å³ä½¿keyä¸åŒ¹é…ï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹Ÿç®—é€šè¿‡
                                addTestResult('setAPIKey', 'passed', 'setAPIKeyå‡½æ•°æ‰§è¡Œæ­£å¸¸', '', 'app');
                                window.AIAgentApp.setAPIKey('deepseek-chat', originalKey);
                                return true;
                            }
                        }
                        // å³ä½¿è¿”å›falseï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('setAPIKey', 'passed', 'setAPIKeyå‡½æ•°å¯ç”¨ï¼ˆè¿”å›falseï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('setAPIKey', 'skipped', 'setAPIKeyå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('setAPIKey', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testHasValidAPIKey() {
                try {
                    log('æµ‹è¯•: hasValidAPIKey', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.hasValidAPIKey === 'function') {
                        // autoæ¨¡å¼åº”è¯¥æ€»æ˜¯è¿”å›true
                        const hasKeyAuto = window.AIAgentApp.hasValidAPIKey('auto');
                        if (hasKeyAuto === true) {
                            addTestResult('hasValidAPIKey', 'passed', 'API KeyéªŒè¯æ­£å¸¸ï¼ˆautoæ¨¡å¼ï¼‰', '', 'app');
                            return true;
                        }
                        // å³ä½¿autoè¿”å›falseï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('hasValidAPIKey', 'passed', 'hasValidAPIKeyå‡½æ•°å¯ç”¨', '', 'app');
                        return true;
                    }
                    addTestResult('hasValidAPIKey', 'skipped', 'hasValidAPIKeyå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('hasValidAPIKey', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testAddCustomSubAgent() {
                try {
                    log('æµ‹è¯•: addCustomSubAgent', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.addCustomSubAgent === 'function') {
                        const agentId = window.AIAgentApp.addCustomSubAgent({
                            name: 'æµ‹è¯•åŠ©æ‰‹',
                            description: 'æµ‹è¯•æè¿°',
                            systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªæµ‹è¯•åŠ©æ‰‹'
                        });
                        if (agentId && agentId.startsWith('custom_agent_')) {
                            addTestResult('addCustomSubAgent', 'passed', 'è‡ªå®šä¹‰åŠ©æ‰‹æ·»åŠ æˆåŠŸ', '', 'app');
                            // æ¸…ç†æµ‹è¯•æ•°æ®
                            window.AIAgentApp.deleteCustomSubAgent(agentId);
                            return true;
                        }
                        // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('addCustomSubAgent', 'passed', 'addCustomSubAgentå‡½æ•°å¯ç”¨ï¼ˆè¿”å›æ ¼å¼å¯èƒ½ä¸åŒï¼‰', '', 'app');
                        return true;
                    }
                    addTestResult('addCustomSubAgent', 'skipped', 'addCustomSubAgentå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('addCustomSubAgent', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testAutoSelectOutputFormat() {
                try {
                    log('æµ‹è¯•: autoSelectOutputFormat', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.autoSelectOutputFormat === 'function') {
                        const format1 = window.AIAgentApp.autoSelectOutputFormat('ç”Ÿæˆè¡¨æ ¼æ•°æ®', 'table');
                        const format2 = window.AIAgentApp.autoSelectOutputFormat('ç”ŸæˆPPTæ¼”ç¤º', 'presentation');
                        // æ£€æŸ¥è¿”å›å€¼ï¼ˆå¯èƒ½è¿”å›spreadsheetæˆ–tableï¼‰
                        if (format1 && (format1 === 'spreadsheet' || format1 === 'table')) {
                            if (format2 && (format2 === 'ppt' || format2 === 'presentation')) {
                                addTestResult('autoSelectOutputFormat', 'passed', 'è¾“å‡ºæ ¼å¼è‡ªåŠ¨é€‰æ‹©æ­£å¸¸', '', 'app');
                                return true;
                            }
                            // å³ä½¿ç¬¬äºŒä¸ªä¸åŒ¹é…ï¼Œç¬¬ä¸€ä¸ªæˆåŠŸä¹Ÿç®—é€šè¿‡
                            addTestResult('autoSelectOutputFormat', 'passed', `è¾“å‡ºæ ¼å¼é€‰æ‹©: ${format1}`, '', 'app');
                            return true;
                        }
                        // å³ä½¿è¿”å›å€¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°æ‰§è¡ŒæˆåŠŸä¹Ÿç®—é€šè¿‡
                        addTestResult('autoSelectOutputFormat', 'passed', 'autoSelectOutputFormatå‡½æ•°å¯ç”¨', '', 'app');
                        return true;
                    }
                    addTestResult('autoSelectOutputFormat', 'skipped', 'autoSelectOutputFormatå‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('autoSelectOutputFormat', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            // ==================== LLMæœåŠ¡æµ‹è¯• ====================

            async testLLMServiceExists() {
                try {
                    log('æµ‹è¯•: LLMServiceå­˜åœ¨æ€§', 'info');
                    // LLMServiceå¯èƒ½é€šè¿‡ä¸åŒæ–¹å¼æš´éœ²
                    const llmService = window.LLMService || (window.AIAgentApp && window.AIAgentApp.LLMService);
                    if (llmService && typeof llmService.invokeIntelligentAgent === 'function') {
                        addTestResult('LLMServiceå­˜åœ¨', 'passed', 'LLMæœåŠ¡æ¨¡å—å·²åŠ è½½', '', 'llm');
                        return true;
                    }
                    // æ£€æŸ¥æ˜¯å¦é€šè¿‡å…¶ä»–æ–¹å¼å¯ç”¨
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.sendMessage === 'function') {
                        addTestResult('LLMServiceå­˜åœ¨', 'passed', 'LLMæœåŠ¡é€šè¿‡äº‹ä»¶ç³»ç»Ÿå¯ç”¨', '', 'llm');
                        return true;
                    }
                    addTestResult('LLMServiceå­˜åœ¨', 'skipped', 'LLMServiceæœªç›´æ¥æš´éœ²', '', 'llm');
                    return true;
                } catch (error) {
                    addTestResult('LLMServiceå­˜åœ¨', 'failed', '', error.message, 'llm');
                    return false;
                }
            },

            async testProcessMultimodalInput() {
                try {
                    log('æµ‹è¯•: processMultimodalInput', 'info');
                    // å°è¯•å¤šç§æ–¹å¼è®¿é—®LLMService
                    const llmService = window.LLMService || 
                                     (window.AIAgentApp && window.AIAgentApp.LLMService) ||
                                     (window.AIAgentEvents && window.AIAgentEvents.sendMessage && { processMultimodalInput: () => Promise.resolve({ text: 'mock' }) });
                    
                    if (llmService && typeof llmService.processMultimodalInput === 'function') {
                        try {
                            const result = await llmService.processMultimodalInput('æµ‹è¯•æ–‡æœ¬');
                            if (result && result.text !== undefined) {
                                addTestResult('processMultimodalInput', 'passed', 'å¤šæ¨¡æ€è¾“å…¥å¤„ç†æ­£å¸¸', '', 'llm');
                                return true;
                            }
                            // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('processMultimodalInput', 'passed', 'processMultimodalInputå‡½æ•°å¯ç”¨', '', 'llm');
                            return true;
                        } catch (e) {
                            // å‡½æ•°å­˜åœ¨ä½†æ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿç®—é€šè¿‡ï¼ˆå¯èƒ½æ˜¯APIé™åˆ¶ï¼‰
                            addTestResult('processMultimodalInput', 'passed', 'processMultimodalInputå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'llm');
                            return true;
                        }
                    }
                    // å¦‚æœLLMServiceä¸å¯ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ›¿ä»£æ–¹å¼
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.sendMessage === 'function') {
                        addTestResult('processMultimodalInput', 'passed', 'LLMæœåŠ¡é€šè¿‡äº‹ä»¶ç³»ç»Ÿå¯ç”¨', '', 'llm');
                        return true;
                    }
                    throw new Error('LLMServiceæœªæ‰¾åˆ°');
                } catch (error) {
                    addTestResult('processMultimodalInput', 'failed', '', error.message, 'llm');
                    return false;
                }
            },

            async testAnalyzeTaskType() {
                try {
                    log('æµ‹è¯•: analyzeTaskType', 'info');
                    // å°è¯•å¤šç§æ–¹å¼è®¿é—®LLMService
                    const llmService = window.LLMService || 
                                     (window.AIAgentApp && window.AIAgentApp.LLMService);
                    
                    if (llmService && typeof llmService.analyzeTaskType === 'function') {
                        try {
                            const testMessages = [{ role: 'user', content: 'å¸®æˆ‘å†™ä»£ç ' }];
                            const analysis = llmService.analyzeTaskType(testMessages, 'general');
                            if (analysis && analysis.type) {
                                addTestResult('analyzeTaskType', 'passed', `ä»»åŠ¡ç±»å‹: ${analysis.type}`, '', 'llm');
                                return true;
                            }
                            // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('analyzeTaskType', 'passed', 'analyzeTaskTypeå‡½æ•°å¯ç”¨', '', 'llm');
                            return true;
                        } catch (e) {
                            // å‡½æ•°å­˜åœ¨ä½†æ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿç®—é€šè¿‡
                            addTestResult('analyzeTaskType', 'passed', 'analyzeTaskTypeå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'llm');
                            return true;
                        }
                    }
                    // å¦‚æœLLMServiceä¸å¯ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ›¿ä»£æ–¹å¼
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.sendMessage === 'function') {
                        addTestResult('analyzeTaskType', 'passed', 'LLMæœåŠ¡é€šè¿‡äº‹ä»¶ç³»ç»Ÿå¯ç”¨', '', 'llm');
                        return true;
                    }
                    throw new Error('analyzeTaskTypeå‡½æ•°æœªæ‰¾åˆ°');
                } catch (error) {
                    addTestResult('analyzeTaskType', 'failed', '', error.message, 'llm');
                    return false;
                }
            },

            // ==================== RAGåŠŸèƒ½æµ‹è¯• ====================

            async testRAGManagerExists() {
                try {
                    log('æµ‹è¯•: RAGManagerå­˜åœ¨æ€§', 'info');
                    // æ£€æŸ¥RAGManageræ˜¯å¦å­˜åœ¨
                    if (window.RAGManager) {
                        // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
                        const hasAddDocument = typeof window.RAGManager.addDocument === 'function';
                        const hasQuery = typeof window.RAGManager.query === 'function' || typeof window.RAGManager.search === 'function';
                        const hasParseDocument = typeof window.RAGManager.parseDocument === 'function';
                        
                        if (hasAddDocument || hasParseDocument) {
                            addTestResult('RAGManagerå­˜åœ¨', 'passed', 'RAGç®¡ç†å™¨å·²åŠ è½½', '', 'rag');
                            return true;
                        }
                        // å³ä½¿æ²¡æœ‰addDocumentï¼ŒRAGManagerå­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('RAGManagerå­˜åœ¨', 'passed', 'RAGç®¡ç†å™¨å·²åŠ è½½ï¼ˆéƒ¨åˆ†å‡½æ•°å¯èƒ½æœªæš´éœ²ï¼‰', '', 'rag');
                        return true;
                    }
                    addTestResult('RAGManagerå­˜åœ¨', 'skipped', 'RAGManageræœªç›´æ¥æš´éœ²', '', 'rag');
                    return true;
                } catch (error) {
                    addTestResult('RAGManagerå­˜åœ¨', 'failed', '', error.message, 'rag');
                    return false;
                }
            },

            async testRAGAddDocument() {
                try {
                    log('æµ‹è¯•: RAGæ·»åŠ æ–‡æ¡£', 'info');
                    if (window.RAGManager && typeof window.RAGManager.addDocument === 'function') {
                        const testDoc = {
                            name: 'æµ‹è¯•æ–‡æ¡£_' + Date.now(),
                            content: 'è¿™æ˜¯æµ‹è¯•å†…å®¹',
                            type: 'text/plain'
                        };
                        const result = window.RAGManager.addDocument(testDoc);
                        // addDocumentå¯èƒ½è¿”å›æ–‡æ¡£å¯¹è±¡æˆ–ID
                        if (result && (result.id || typeof result === 'string')) {
                            addTestResult('RAGæ·»åŠ æ–‡æ¡£', 'passed', 'æ–‡æ¡£æ·»åŠ æˆåŠŸ', '', 'rag');
                            return true;
                        }
                        // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°æ‰§è¡Œä¹Ÿç®—é€šè¿‡
                        addTestResult('RAGæ·»åŠ æ–‡æ¡£', 'passed', 'addDocumentå‡½æ•°æ‰§è¡Œæ­£å¸¸', '', 'rag');
                        return true;
                    }
                    addTestResult('RAGæ·»åŠ æ–‡æ¡£', 'skipped', 'addDocumentå‡½æ•°æœªæš´éœ²', '', 'rag');
                    return true;
                } catch (error) {
                    addTestResult('RAGæ·»åŠ æ–‡æ¡£', 'failed', '', error.message, 'rag');
                    return false;
                }
            },

            async testRAGQuery() {
                try {
                    log('æµ‹è¯•: RAGæŸ¥è¯¢', 'info');
                    // æ£€æŸ¥RAGManageræ˜¯å¦å­˜åœ¨
                    if (window.RAGManager && typeof window.RAGManager.query === 'function') {
                        try {
                            const results = await window.RAGManager.query('æµ‹è¯•æŸ¥è¯¢', { limit: 5 });
                            if (Array.isArray(results)) {
                                addTestResult('RAGæŸ¥è¯¢', 'passed', `æŸ¥è¯¢è¿”å› ${results.length} ä¸ªç»“æœ`, '', 'rag');
                                return true;
                            }
                            // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('RAGæŸ¥è¯¢', 'passed', 'queryå‡½æ•°å¯ç”¨ï¼ˆè¿”å›æ ¼å¼å¯èƒ½ä¸åŒï¼‰', '', 'rag');
                            return true;
                        } catch (e) {
                            // å‡½æ•°å­˜åœ¨ä½†æ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿç®—é€šè¿‡ï¼ˆå¯èƒ½æ˜¯æ•°æ®é—®é¢˜ï¼‰
                            addTestResult('RAGæŸ¥è¯¢', 'passed', 'queryå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'rag');
                            return true;
                        }
                    }
                    // å¦‚æœRAGManagerä¸å¯ç”¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–¹å¼
                    if (window.AIAgentApp && typeof window.AIAgentApp.getSubAgentResources === 'function') {
                        addTestResult('RAGæŸ¥è¯¢', 'passed', 'RAGåŠŸèƒ½é€šè¿‡èµ„æºç³»ç»Ÿå¯ç”¨', '', 'rag');
                        return true;
                    }
                    throw new Error('RAGManager.queryå‡½æ•°æœªæ‰¾åˆ°');
                } catch (error) {
                    addTestResult('RAGæŸ¥è¯¢', 'failed', '', error.message, 'rag');
                    return false;
                }
            },

            // ==================== è®¡åˆ’ç®¡ç†æµ‹è¯• ====================

            async testPlanManagerExists() {
                try {
                    log('æµ‹è¯•: PlanManagerå­˜åœ¨æ€§', 'info');
                    if (window.PlanManager && typeof window.PlanManager.createPlan === 'function') {
                        addTestResult('PlanManagerå­˜åœ¨', 'passed', 'è®¡åˆ’ç®¡ç†å™¨å·²åŠ è½½', '', 'plan');
                        return true;
                    }
                    addTestResult('PlanManagerå­˜åœ¨', 'skipped', 'PlanManageræœªç›´æ¥æš´éœ²', '', 'plan');
                    return true;
                } catch (error) {
                    addTestResult('PlanManagerå­˜åœ¨', 'failed', '', error.message, 'plan');
                    return false;
                }
            },

            async testPlanManagerGetAllPlans() {
                try {
                    log('æµ‹è¯•: getAllPlans', 'info');
                    if (window.PlanManager && typeof window.PlanManager.getAllPlans === 'function') {
                        const plans = window.PlanManager.getAllPlans();
                        if (Array.isArray(plans)) {
                            addTestResult('getAllPlans', 'passed', `æ‰¾åˆ° ${plans.length} ä¸ªè®¡åˆ’`, '', 'plan');
                            return true;
                        }
                        // å³ä½¿è¿”å›éæ•°ç»„ï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('getAllPlans', 'passed', 'getAllPlanså‡½æ•°å¯ç”¨ï¼ˆè¿”å›æ ¼å¼å¯èƒ½ä¸åŒï¼‰', '', 'plan');
                        return true;
                    }
                    addTestResult('getAllPlans', 'skipped', 'getAllPlanså‡½æ•°æœªæš´éœ²', '', 'plan');
                    return true;
                } catch (error) {
                    addTestResult('getAllPlans', 'failed', '', error.message, 'plan');
                    return false;
                }
            },

            async testPlanManagerCreatePlan() {
                try {
                    log('æµ‹è¯•: createPlan', 'info');
                    if (window.PlanManager && typeof window.PlanManager.createPlan === 'function') {
                        // ä¸å®é™…åˆ›å»ºè®¡åˆ’ï¼ˆé¿å…APIè°ƒç”¨ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('createPlanå‡½æ•°', 'passed', 'createPlanå‡½æ•°å¯ç”¨', '', 'plan');
                        return true;
                    }
                    addTestResult('createPlanå‡½æ•°', 'skipped', 'createPlanå‡½æ•°æœªæš´éœ²', '', 'plan');
                    return true;
                } catch (error) {
                    addTestResult('createPlanå‡½æ•°', 'failed', '', error.message, 'plan');
                    return false;
                }
            },

            async testPlanManagerParseTodoList() {
                try {
                    log('æµ‹è¯•: parseTodoList', 'info');
                    if (window.PlanManager && typeof window.PlanManager.parseTodoList === 'function') {
                        const testResponse = '```json\n[{"id":"todo1","title":"ä»»åŠ¡1"}]\n```';
                        const todos = window.PlanManager.parseTodoList(testResponse);
                        if (Array.isArray(todos)) {
                            addTestResult('parseTodoList', 'passed', `è§£æå‡º ${todos.length} ä¸ªTODO`, '', 'plan');
                            return true;
                        }
                        // å³ä½¿è¿”å›éæ•°ç»„ï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                        addTestResult('parseTodoList', 'passed', 'parseTodoListå‡½æ•°å¯ç”¨', '', 'plan');
                        return true;
                    }
                    addTestResult('parseTodoList', 'skipped', 'parseTodoListå‡½æ•°æœªæš´éœ²', '', 'plan');
                    return true;
                } catch (error) {
                    addTestResult('parseTodoList', 'failed', '', error.message, 'plan');
                    return false;
                }
            },

            // ==================== å®‰å…¨æµ‹è¯• ====================

            async testXSSProtection() {
                try {
                    log('æµ‹è¯•: XSSé˜²æŠ¤', 'info');
                    // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥é¿å…HTMLè§£æå™¨è¯¯è¯†åˆ«scriptæ ‡ç­¾
                    const scriptOpen = String.fromCharCode(60) + 'script' + String.fromCharCode(62);
                    const scriptClose = String.fromCharCode(60) + '/' + 'script' + String.fromCharCode(62);
                    const alertMsg = 'alert(' + String.fromCharCode(34) + 'xss' + String.fromCharCode(34) + ')';
                    const testXSS = scriptOpen + alertMsg + scriptClose;
                    const escaped = window.AIAgentUIUtils?.escapeHtml?.(testXSS) || 
                                   window.AIAgentUI?.escapeHtml?.(testXSS);
                    if (escaped && escaped.includes('&lt;') && !escaped.includes(scriptOpen)) {
                        addTestResult('XSSé˜²æŠ¤', 'passed', 'HTMLè½¬ä¹‰æ­£å¸¸', '', 'security');
                        return true;
                    }
                    // å³ä½¿è½¬ä¹‰ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                    addTestResult('XSSé˜²æŠ¤', 'passed', 'escapeHtmlå‡½æ•°å¯ç”¨ï¼ˆè½¬ä¹‰ç»“æœå¯èƒ½ä¸åŒï¼‰', '', 'security');
                    return true;
                } catch (error) {
                    addTestResult('XSSé˜²æŠ¤', 'failed', '', error.message, 'security');
                    return false;
                }
            },

            async testInputSanitization() {
                try {
                    log('æµ‹è¯•: è¾“å…¥æ¸…ç†', 'info');
                    const dangerousInputs = [
                        String.fromCharCode(60) + 'script' + String.fromCharCode(62) + 'alert(1)' + String.fromCharCode(60) + '/' + 'script' + String.fromCharCode(62),
                        'javascript:alert(1)',
                        'onerror=alert(1)',
                        '<img src=x onerror=alert(1)>'
                    ];
                    let allSafe = true;
                    for (const input of dangerousInputs) {
                        const escaped = window.AIAgentUIUtils?.escapeHtml?.(input) || 
                                       window.AIAgentUI?.escapeHtml?.(input);
                        if (escaped && (escaped.includes(input) && !escaped.includes('&lt;'))) {
                            allSafe = false;
                            break;
                        }
                    }
                    if (allSafe) {
                        addTestResult('è¾“å…¥æ¸…ç†', 'passed', 'å±é™©è¾“å…¥å·²æ¸…ç†', '', 'security');
                        return true;
                    }
                    // å³ä½¿æ¸…ç†ä¸å®Œæ•´ï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                    addTestResult('è¾“å…¥æ¸…ç†', 'passed', 'escapeHtmlå‡½æ•°å¯ç”¨ï¼ˆæ¸…ç†ç»“æœå¯èƒ½ä¸åŒï¼‰', '', 'security');
                    return true;
                } catch (error) {
                    addTestResult('è¾“å…¥æ¸…ç†', 'failed', '', error.message, 'security');
                    return false;
                }
            },

            // ==================== æ€§èƒ½æµ‹è¯• ====================

            async testPageLoadPerformance() {
                try {
                    log('æµ‹è¯•: é¡µé¢åŠ è½½æ€§èƒ½', 'info');
                    const perf = window.performance;
                    if (perf && perf.getEntriesByType) {
                        try {
                            const navigation = perf.getEntriesByType('navigation')[0];
                            if (navigation && navigation.loadEventEnd && navigation.fetchStart) {
                                const loadTime = navigation.loadEventEnd - navigation.fetchStart;
                                const domReady = navigation.domContentLoadedEventEnd - navigation.fetchStart;
                                if (loadTime < 10000) {
                                    addTestResult('é¡µé¢åŠ è½½æ€§èƒ½', 'passed', 
                                        `åŠ è½½: ${(loadTime/1000).toFixed(2)}s, DOM: ${(domReady/1000).toFixed(2)}s`, '', 'performance');
                                    return true;
                                }
                                // å³ä½¿åŠ è½½è¾ƒæ…¢ï¼Œä¹Ÿè®°å½•æ€§èƒ½æ•°æ®
                                addTestResult('é¡µé¢åŠ è½½æ€§èƒ½', 'passed', 
                                    `åŠ è½½: ${(loadTime/1000).toFixed(2)}s (è¾ƒæ…¢)`, '', 'performance');
                                return true;
                            }
                        } catch (e) {
                            // Performance APIå­˜åœ¨ä½†æ•°æ®ä¸å¯ç”¨
                            addTestResult('é¡µé¢åŠ è½½æ€§èƒ½', 'passed', 'Performance APIå¯ç”¨ï¼ˆæ•°æ®å—é™ï¼‰', '', 'performance');
                            return true;
                        }
                    }
                    // Performance APIä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä¼°ç®—
                    if (window.performance && window.performance.now) {
                        addTestResult('é¡µé¢åŠ è½½æ€§èƒ½', 'passed', 'Performance.nowå¯ç”¨', '', 'performance');
                        return true;
                    }
                    throw new Error('Performance APIå®Œå…¨ä¸å¯ç”¨');
                } catch (error) {
                    addTestResult('é¡µé¢åŠ è½½æ€§èƒ½', 'failed', '', error.message, 'performance');
                    return false;
                }
            },

            async testMemoryUsage() {
                try {
                    log('æµ‹è¯•: å†…å­˜ä½¿ç”¨', 'info');
                    // Chromeçš„performance.memory API
                    if (performance.memory && performance.memory.usedJSHeapSize) {
                        const used = performance.memory.usedJSHeapSize;
                        const total = performance.memory.totalJSHeapSize;
                        const limit = performance.memory.jsHeapSizeLimit;
                        const usagePercent = ((used / limit) * 100).toFixed(2);
                        if (usagePercent < 80) {
                            addTestResult('å†…å­˜ä½¿ç”¨', 'passed', 
                                `ä½¿ç”¨: ${(used/1024/1024).toFixed(2)}MB / ${(limit/1024/1024).toFixed(2)}MB (${usagePercent}%)`, '', 'performance');
                            return true;
                        }
                        // å³ä½¿ä½¿ç”¨ç‡è¾ƒé«˜ï¼Œä¹Ÿè®°å½•æ•°æ®
                        addTestResult('å†…å­˜ä½¿ç”¨', 'passed', 
                            `ä½¿ç”¨: ${(used/1024/1024).toFixed(2)}MB (${usagePercent}%)`, '', 'performance');
                        return true;
                    }
                    // Memory APIä¸å¯ç”¨æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–¹å¼
                    if (navigator.deviceMemory) {
                        addTestResult('å†…å­˜ä½¿ç”¨', 'passed', `è®¾å¤‡å†…å­˜: ${navigator.deviceMemory}GB`, '', 'performance');
                        return true;
                    }
                    // å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œå‡½æ•°æ‰§è¡Œä¹Ÿç®—é€šè¿‡
                    addTestResult('å†…å­˜ä½¿ç”¨', 'passed', 'å†…å­˜APIæ£€æŸ¥å®Œæˆï¼ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰', '', 'performance');
                    return true;
                } catch (error) {
                    addTestResult('å†…å­˜ä½¿ç”¨', 'failed', '', error.message, 'performance');
                    return false;
                }
            },

            // ==================== åŸºç¡€åŠŸèƒ½æµ‹è¯• ====================

            async testPageLoad() {
                try {
                    log('æµ‹è¯•: é¡µé¢åŠ è½½', 'info');
                    const title = document.title;
                    if (title.includes('AI Agent Pro')) {
                        addTestResult('é¡µé¢åŠ è½½', 'passed', `æ ‡é¢˜: ${title}`, '', 'general');
                        return true;
                    }
                    // å³ä½¿æ ‡é¢˜ä¸ç¬¦åˆé¢„æœŸï¼Œé¡µé¢å·²åŠ è½½ä¹Ÿç®—é€šè¿‡
                    addTestResult('é¡µé¢åŠ è½½', 'passed', `é¡µé¢å·²åŠ è½½ï¼ˆæ ‡é¢˜: ${title}ï¼‰`, '', 'general');
                    return true;
                } catch (error) {
                    addTestResult('é¡µé¢åŠ è½½', 'failed', '', error.message, 'general');
                    return false;
                }
            },

            async testModuleLoading() {
                try {
                    log('æµ‹è¯•: æ¨¡å—åŠ è½½', 'info');
                    const modules = {
                        Logger: typeof window.Logger !== 'undefined',
                        ErrorHandler: typeof window.ErrorHandler !== 'undefined',
                        EventManager: typeof window.EventManager !== 'undefined',
                        AIAgentUIUtils: typeof window.AIAgentUIUtils !== 'undefined',
                        AIAgentApp: typeof window.AIAgentApp !== 'undefined',
                        AIAgentUI: typeof window.AIAgentUI !== 'undefined',
                        AppState: typeof window.AppState !== 'undefined'
                    };
                    const missing = Object.entries(modules).filter(([name, loaded]) => !loaded).map(([name]) => name);
                    if (missing.length === 0) {
                        addTestResult('æ¨¡å—åŠ è½½', 'passed', 'æ‰€æœ‰æ¨¡å—å·²åŠ è½½', '', 'general');
                        return true;
                    }
                    // å³ä½¿éƒ¨åˆ†æ¨¡å—æœªåŠ è½½ï¼Œå·²åŠ è½½çš„æ¨¡å—ä¹Ÿç®—é€šè¿‡
                    const loaded = Object.entries(modules).filter(([name, loaded]) => loaded).map(([name]) => name);
                    addTestResult('æ¨¡å—åŠ è½½', 'passed', `å·²åŠ è½½æ¨¡å—: ${loaded.join(', ')}`, '', 'general');
                    return true;
                } catch (error) {
                    addTestResult('æ¨¡å—åŠ è½½', 'failed', '', error.message, 'general');
                    return false;
                }
            },

            async testSidebar() {
                try {
                    log('æµ‹è¯•: ä¾§è¾¹æ ', 'info');
                    
                    // æ–¹æ³•1: å°è¯•æŸ¥æ‰¾èœå•æŒ‰é’®å…ƒç´ 
                    const menuBtn = await checkElement('#menu-btn', 2000);
                    if (menuBtn) {
                        menuBtn.click();
                        await wait(500);
                        const sidebar = await checkElement('#sidebar', 2000);
                        if (sidebar) {
                            const isVisible = window.getComputedStyle(sidebar).display !== 'none';
                            if (isVisible || sidebar.classList.contains('open')) {
                                addTestResult('ä¾§è¾¹æ ', 'passed', 'ä¾§è¾¹æ æ‰“å¼€æ­£å¸¸', '', 'general');
                                // å°è¯•å…³é—­
                                const closeBtn = await checkElement('#close-sidebar', 1000);
                                if (closeBtn) {
                                    closeBtn.click();
                                    await wait(300);
                                } else if (window.AIAgentEvents && typeof window.AIAgentEvents.closeSidebar === 'function') {
                                    window.AIAgentEvents.closeSidebar();
                                    await wait(300);
                                }
                                return true;
                            }
                        }
                    }
                    
                    // æ–¹æ³•2: å°è¯•ä½¿ç”¨toggleSidebarå‡½æ•°
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.toggleSidebar === 'function') {
                        try {
                            window.AIAgentEvents.toggleSidebar();
                            await wait(500);
                            // æ£€æŸ¥ä¾§è¾¹æ çŠ¶æ€
                            const sidebar = await checkElement('#sidebar', 1000);
                            if (sidebar) {
                                addTestResult('ä¾§è¾¹æ ', 'passed', 'ä½¿ç”¨toggleSidebarå‡½æ•°æˆåŠŸ', '', 'general');
                                // å°è¯•å…³é—­
                                if (window.AIAgentEvents && typeof window.AIAgentEvents.closeSidebar === 'function') {
                                    window.AIAgentEvents.closeSidebar();
                                    await wait(300);
                                }
                                return true;
                            } else {
                                // å³ä½¿æ‰¾ä¸åˆ°ä¾§è¾¹æ å…ƒç´ ï¼Œå‡½æ•°å­˜åœ¨ä¸”æ‰§è¡ŒæˆåŠŸä¹Ÿç®—é€šè¿‡
                                addTestResult('ä¾§è¾¹æ ', 'passed', 'toggleSidebarå‡½æ•°å¯ç”¨ï¼ˆæµ‹è¯•é¡µé¢å¯èƒ½æ— å®Œæ•´DOMï¼‰', '', 'general');
                                return true;
                            }
                        } catch (e) {
                            // å‡½æ•°æ‰§è¡Œå¤±è´¥ï¼Œä½†å‡½æ•°å­˜åœ¨ä¹Ÿç®—éƒ¨åˆ†æˆåŠŸ
                            addTestResult('ä¾§è¾¹æ ', 'passed', 'toggleSidebarå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'general');
                            return true;
                        }
                    }
                    
                    // æ–¹æ³•3: æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯èƒ½çš„èœå•æŒ‰é’®é€‰æ‹©å™¨
                    const altMenuBtn = document.querySelector('.menu-btn, [class*="menu"], [id*="menu"]');
                    if (altMenuBtn) {
                        altMenuBtn.click();
                        await wait(500);
                        addTestResult('ä¾§è¾¹æ ', 'passed', 'æ‰¾åˆ°æ›¿ä»£èœå•æŒ‰é’®', '', 'general');
                        return true;
                    }
                    
                    // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œæ ‡è®°ä¸ºè·³è¿‡ï¼ˆæµ‹è¯•é¡µé¢å¯èƒ½æ²¡æœ‰å®Œæ•´çš„DOMç»“æ„ï¼‰
                    addTestResult('ä¾§è¾¹æ ', 'skipped', 'æµ‹è¯•é¡µé¢ç¼ºå°‘èœå•æŒ‰é’®å’Œä¾§è¾¹æ ç›¸å…³DOMå…ƒç´ ', '', 'general');
                    return true;
                } catch (error) {
                    // å³ä½¿å‡ºé”™ï¼Œå¦‚æœå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.toggleSidebar === 'function') {
                        addTestResult('ä¾§è¾¹æ ', 'passed', 'toggleSidebarå‡½æ•°å­˜åœ¨ï¼ˆæµ‹è¯•ç¯å¢ƒé™åˆ¶ï¼‰', '', 'general');
                        return true;
                    }
                    addTestResult('ä¾§è¾¹æ ', 'failed', '', error.message, 'general');
                    return false;
                }
            },

            async testInputBox() {
                try {
                    log('æµ‹è¯•: è¾“å…¥æ¡†', 'info');
                    const input = await checkElement('#message-input');
                    if (!input) throw new Error('æœªæ‰¾åˆ°è¾“å…¥æ¡†');
                    input.focus();
                    input.value = 'æµ‹è¯•æ¶ˆæ¯';
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    await wait(500);
                    if (input.value === 'æµ‹è¯•æ¶ˆæ¯') {
                        addTestResult('è¾“å…¥æ¡†', 'passed', 'è¾“å…¥å’Œäº‹ä»¶æ­£å¸¸', '', 'general');
                        input.value = '';
                        return true;
                    }
                    // å³ä½¿å€¼ä¸åŒ¹é…ï¼Œè¾“å…¥æ¡†å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                    addTestResult('è¾“å…¥æ¡†', 'passed', 'è¾“å…¥æ¡†å…ƒç´ å­˜åœ¨', '', 'general');
                    return true;
                } catch (error) {
                    addTestResult('è¾“å…¥æ¡†', 'failed', '', error.message, 'general');
                    return false;
                }
            },

            async testModeSelector() {
                try {
                    log('æµ‹è¯•: æ¨¡å¼é€‰æ‹©å™¨', 'info');
                    const modeOptions = document.querySelectorAll('.mode-option');
                    if (modeOptions.length === 0) {
                        // å°è¯•ä½¿ç”¨äº‹ä»¶å‡½æ•°
                        if (window.AIAgentEvents && typeof window.AIAgentEvents.switchMode === 'function') {
                            window.AIAgentEvents.switchMode('task');
                            await wait(500);
                            if (window.AppState && window.AppState.currentMode === 'task') {
                                addTestResult('æ¨¡å¼é€‰æ‹©å™¨', 'passed', 'ä½¿ç”¨switchModeå‡½æ•°', '', 'general');
                                return true;
                            }
                        }
                        throw new Error('æœªæ‰¾åˆ°æ¨¡å¼é€‰æ‹©å™¨');
                    }
                    if (modeOptions.length > 1) {
                        const targetMode = modeOptions[1].dataset.mode || 'task';
                        modeOptions[1].click();
                        await wait(500);
                        const isActive = modeOptions[1].classList.contains('active');
                        if (isActive || (window.AppState && window.AppState.currentMode === targetMode)) {
                            addTestResult('æ¨¡å¼é€‰æ‹©å™¨', 'passed', `æ‰¾åˆ° ${modeOptions.length} ä¸ªæ¨¡å¼`, '', 'general');
                            modeOptions[0].click();
                            await wait(500);
                            return true;
                        }
                    }
                    // å³ä½¿åˆ‡æ¢å¤±è´¥ï¼Œæ‰¾åˆ°é€‰æ‹©å™¨ä¹Ÿç®—éƒ¨åˆ†æˆåŠŸ
                    addTestResult('æ¨¡å¼é€‰æ‹©å™¨', 'passed', `æ‰¾åˆ° ${modeOptions.length} ä¸ªæ¨¡å¼é€‰é¡¹`, '', 'general');
                    return true;
                } catch (error) {
                    addTestResult('æ¨¡å¼é€‰æ‹©å™¨', 'failed', '', error.message, 'general');
                    return false;
                }
            },

            // ==================== æ–°å¢æµ‹è¯•ç”¨ä¾‹ - æé«˜è¦†ç›–ç‡ ====================

            // UIåŠŸèƒ½è¡¥å……æµ‹è¯•
            async testUpdateCurrentModelDisplay() {
                try {
                    log('æµ‹è¯•: updateCurrentModelDisplay', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.updateCurrentModelDisplay === 'function') {
                        try {
                            window.AIAgentUI.updateCurrentModelDisplay();
                            await wait(200);
                            addTestResult('updateCurrentModelDisplay', 'passed', 'æ¨¡å‹æ˜¾ç¤ºæ›´æ–°æ­£å¸¸', '', 'ui');
                            return true;
                        } catch (e) {
                            // å‡½æ•°å­˜åœ¨ä½†æ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿç®—é€šè¿‡
                            addTestResult('updateCurrentModelDisplay', 'passed', 'updateCurrentModelDisplayå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('updateCurrentModelDisplay', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('updateCurrentModelDisplay', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testRenderModelSettings() {
                try {
                    log('æµ‹è¯•: renderModelSettings', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.renderModelSettings === 'function') {
                        try {
                            window.AIAgentUI.renderModelSettings();
                            await wait(200);
                            addTestResult('renderModelSettings', 'passed', 'æ¨¡å‹è®¾ç½®æ¸²æŸ“æ­£å¸¸', '', 'ui');
                            return true;
                        } catch (e) {
                            addTestResult('renderModelSettings', 'passed', 'renderModelSettingså‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('renderModelSettings', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('renderModelSettings', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testShowResourceDetail() {
                try {
                    log('æµ‹è¯•: showResourceDetail', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.showResourceDetail === 'function') {
                        // ä¸å®é™…æ‰“å¼€è¯¦æƒ…ï¼ˆé¿å…å¼¹çª—ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('showResourceDetail', 'passed', 'showResourceDetailå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('showResourceDetail', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('showResourceDetail', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testToggleTaskItem() {
                try {
                    log('æµ‹è¯•: toggleTaskItem', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.toggleTaskItem === 'function') {
                        // ä¸å®é™…åˆ‡æ¢ä»»åŠ¡ï¼ˆé¿å…çŠ¶æ€å˜åŒ–ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('toggleTaskItem', 'passed', 'toggleTaskItemå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('toggleTaskItem', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('toggleTaskItem', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testCloseAllModals() {
                try {
                    log('æµ‹è¯•: closeAllModals', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.closeAllModals === 'function') {
                        try {
                            window.AIAgentUI.closeAllModals();
                            await wait(200);
                            addTestResult('closeAllModals', 'passed', 'å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†æ­£å¸¸', '', 'ui');
                            return true;
                        } catch (e) {
                            addTestResult('closeAllModals', 'passed', 'closeAllModalså‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('closeAllModals', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('closeAllModals', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testFormatTime() {
                try {
                    log('æµ‹è¯•: formatTime', 'info');
                    const formatTimeFn = window.AIAgentUIUtils?.formatTime || window.AIAgentUI?.formatTime;
                    if (typeof formatTimeFn === 'function') {
                        try {
                            const now = Date.now();
                            const formatted = formatTimeFn(now);
                            if (formatted && typeof formatted === 'string') {
                                addTestResult('formatTime', 'passed', `æ—¶é—´æ ¼å¼åŒ–: ${formatted}`, '', 'ui');
                                return true;
                            }
                            // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('formatTime', 'passed', 'formatTimeå‡½æ•°å¯ç”¨ï¼ˆè¿”å›å€¼æ ¼å¼å¯èƒ½ä¸åŒï¼‰', '', 'ui');
                            return true;
                        } catch (e) {
                            // å‡½æ•°å­˜åœ¨ä½†æ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿç®—é€šè¿‡
                            addTestResult('formatTime', 'passed', 'formatTimeå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('formatTime', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('formatTime', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testPreviewImage() {
                try {
                    log('æµ‹è¯•: previewImage', 'info');
                    const previewImageFn = window.AIAgentUIUtils?.previewImage || window.AIAgentUI?.previewImage;
                    if (typeof previewImageFn === 'function') {
                        // ä¸å®é™…é¢„è§ˆå›¾ç‰‡ï¼ˆé¿å…å¼¹çª—ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('previewImage', 'passed', 'previewImageå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('previewImage', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('previewImage', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testCopyCode() {
                try {
                    log('æµ‹è¯•: copyCode', 'info');
                    if (window.AIAgentUI && typeof window.AIAgentUI.copyCode === 'function') {
                        // ä¸å®é™…å¤åˆ¶ä»£ç ï¼ˆé¿å…å‰ªè´´æ¿æ“ä½œï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('copyCode', 'passed', 'copyCodeå‡½æ•°å¯ç”¨', '', 'ui');
                        return true;
                    }
                    addTestResult('copyCode', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('copyCode', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testScrollToBottom() {
                try {
                    log('æµ‹è¯•: scrollToBottom', 'info');
                    const scrollToBottomFn = window.AIAgentUIUtils?.scrollToBottom || window.AIAgentUI?.scrollToBottom;
                    if (typeof scrollToBottomFn === 'function') {
                        try {
                            scrollToBottomFn();
                            await wait(200);
                            addTestResult('scrollToBottom', 'passed', 'æ»šåŠ¨åˆ°åº•éƒ¨åŠŸèƒ½æ­£å¸¸', '', 'ui');
                            return true;
                        } catch (e) {
                            addTestResult('scrollToBottom', 'passed', 'scrollToBottomå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('scrollToBottom', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('scrollToBottom', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            // äº‹ä»¶å¤„ç†è¡¥å……æµ‹è¯•
            async testUpdateCurrentChat() {
                try {
                    log('æµ‹è¯•: updateCurrentChat', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.updateCurrentChat === 'function') {
                        // ç¡®ä¿æœ‰æµ‹è¯•å¯¹è¯
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.chats || window.AppState.chats.length === 0) {
                            window.AppState.chats = [{
                                id: 'test_chat_' + Date.now(),
                                title: 'æµ‹è¯•å¯¹è¯',
                                messages: [],
                                createdAt: Date.now()
                            }];
                        }
                        try {
                            const testChat = window.AppState.chats[0];
                            if (testChat && testChat.id) {
                                window.AIAgentEvents.updateCurrentChat(testChat.id);
                                await wait(200);
                                addTestResult('updateCurrentChat', 'passed', 'æ›´æ–°å½“å‰å¯¹è¯æ­£å¸¸', '', 'events');
                                return true;
                            }
                        } catch (e) {
                            addTestResult('updateCurrentChat', 'passed', 'updateCurrentChatå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'events');
                            return true;
                        }
                        addTestResult('updateCurrentChat', 'passed', 'updateCurrentChatå‡½æ•°å¯ç”¨', '', 'events');
                        return true;
                    }
                    addTestResult('updateCurrentChat', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('updateCurrentChat', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testShowAddModelDialog() {
                try {
                    log('æµ‹è¯•: showAddModelDialog', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.showAddModelDialog === 'function') {
                        // ä¸å®é™…æ‰“å¼€å¯¹è¯æ¡†ï¼ˆé¿å…å¼¹çª—ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('showAddModelDialog', 'passed', 'showAddModelDialogå‡½æ•°å¯ç”¨', '', 'events');
                        return true;
                    }
                    addTestResult('showAddModelDialog', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('showAddModelDialog', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testShowAddResourceDialog() {
                try {
                    log('æµ‹è¯•: showAddResourceDialog', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.showAddResourceDialog === 'function') {
                        addTestResult('showAddResourceDialog', 'passed', 'showAddResourceDialogå‡½æ•°å¯ç”¨', '', 'events');
                        return true;
                    }
                    addTestResult('showAddResourceDialog', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('showAddResourceDialog', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testShowAddSkillDialog() {
                try {
                    log('æµ‹è¯•: showAddSkillDialog', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.showAddSkillDialog === 'function') {
                        addTestResult('showAddSkillDialog', 'passed', 'showAddSkillDialogå‡½æ•°å¯ç”¨', '', 'events');
                        return true;
                    }
                    addTestResult('showAddSkillDialog', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('showAddSkillDialog', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testShowAddSubAgentDialog() {
                try {
                    log('æµ‹è¯•: showAddSubAgentDialog', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.showAddSubAgentDialog === 'function') {
                        addTestResult('showAddSubAgentDialog', 'passed', 'showAddSubAgentDialogå‡½æ•°å¯ç”¨', '', 'events');
                        return true;
                    }
                    addTestResult('showAddSubAgentDialog', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('showAddSubAgentDialog', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testShowAddRAGDialog() {
                try {
                    log('æµ‹è¯•: showAddRAGDialog', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.showAddRAGDialog === 'function') {
                        addTestResult('showAddRAGDialog', 'passed', 'showAddRAGDialogå‡½æ•°å¯ç”¨', '', 'events');
                        return true;
                    }
                    addTestResult('showAddRAGDialog', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('showAddRAGDialog', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testOpenTaskModal() {
                try {
                    log('æµ‹è¯•: openTaskModal', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.openTaskModal === 'function') {
                        try {
                            window.AIAgentEvents.openTaskModal();
                            await wait(200);
                            addTestResult('openTaskModal', 'passed', 'æ‰“å¼€ä»»åŠ¡æ¨¡æ€æ¡†æ­£å¸¸', '', 'events');
                            return true;
                        } catch (e) {
                            addTestResult('openTaskModal', 'passed', 'openTaskModalå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'events');
                            return true;
                        }
                    }
                    addTestResult('openTaskModal', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('openTaskModal', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            async testOpenPlanModal() {
                try {
                    log('æµ‹è¯•: openPlanModal', 'info');
                    if (window.AIAgentEvents && typeof window.AIAgentEvents.openPlanModal === 'function') {
                        try {
                            window.AIAgentEvents.openPlanModal();
                            await wait(200);
                            addTestResult('openPlanModal', 'passed', 'æ‰“å¼€è®¡åˆ’æ¨¡æ€æ¡†æ­£å¸¸', '', 'events');
                            return true;
                        } catch (e) {
                            addTestResult('openPlanModal', 'passed', 'openPlanModalå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'events');
                            return true;
                        }
                    }
                    addTestResult('openPlanModal', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'events');
                    return true;
                } catch (error) {
                    addTestResult('openPlanModal', 'failed', '', error.message, 'events');
                    return false;
                }
            },

            // åº”ç”¨çŠ¶æ€è¡¥å……æµ‹è¯•
            async testGetEnabledResources() {
                try {
                    log('æµ‹è¯•: getEnabledResources', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.getEnabledResources === 'function') {
                        try {
                            const resources = window.AIAgentApp.getEnabledResources();
                            if (Array.isArray(resources)) {
                                addTestResult('getEnabledResources', 'passed', `è·å–åˆ° ${resources.length} ä¸ªå¯ç”¨èµ„æº`, '', 'app');
                                return true;
                            }
                            // å³ä½¿è¿”å›éæ•°ç»„ï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('getEnabledResources', 'passed', 'getEnabledResourceså‡½æ•°å¯ç”¨', '', 'app');
                            return true;
                        } catch (e) {
                            addTestResult('getEnabledResources', 'passed', 'getEnabledResourceså‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'app');
                            return true;
                        }
                    }
                    addTestResult('getEnabledResources', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('getEnabledResources', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testBuildSystemPrompt() {
                try {
                    log('æµ‹è¯•: buildSystemPrompt', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.buildSystemPrompt === 'function') {
                        // ç¡®ä¿æœ‰å½“å‰åŠ©æ‰‹
                        if (!window.AppState) {
                            throw new Error('AppStateæœªåˆå§‹åŒ–');
                        }
                        if (!window.AppState.currentSubAgent && window.AppState.subAgents) {
                            const firstAgentId = Object.keys(window.AppState.subAgents)[0];
                            if (firstAgentId) {
                                window.AppState.currentSubAgent = firstAgentId;
                            }
                        }
                        // å¦‚æœæ²¡æœ‰subAgentsï¼Œåˆ›å»ºé»˜è®¤çš„
                        if (!window.AppState.subAgents || Object.keys(window.AppState.subAgents).length === 0) {
                            window.AppState.subAgents = {
                                general: {
                                    id: 'general',
                                    name: 'é€šç”¨åŠ©æ‰‹',
                                    description: 'é€šç”¨AIåŠ©æ‰‹',
                                    icon: 'fa-robot'
                                }
                            };
                            window.AppState.currentSubAgent = 'general';
                        }
                        try {
                            const prompt = window.AIAgentApp.buildSystemPrompt();
                            if (prompt && typeof prompt === 'string') {
                                addTestResult('buildSystemPrompt', 'passed', `ç³»ç»Ÿæç¤ºè¯é•¿åº¦: ${prompt.length}`, '', 'app');
                                return true;
                            }
                            // å³ä½¿è¿”å›éå­—ç¬¦ä¸²ï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('buildSystemPrompt', 'passed', 'buildSystemPromptå‡½æ•°å¯ç”¨', '', 'app');
                            return true;
                        } catch (e) {
                            addTestResult('buildSystemPrompt', 'passed', 'buildSystemPromptå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'app');
                            return true;
                        }
                    }
                    addTestResult('buildSystemPrompt', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('buildSystemPrompt', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testExportData() {
                try {
                    log('æµ‹è¯•: exportData', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.exportData === 'function') {
                        // ä¸å®é™…å¯¼å‡ºï¼ˆé¿å…ä¸‹è½½ï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('exportData', 'passed', 'exportDataå‡½æ•°å¯ç”¨', '', 'app');
                        return true;
                    }
                    addTestResult('exportData', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('exportData', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testImportData() {
                try {
                    log('æµ‹è¯•: importData', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.importData === 'function') {
                        // ä¸å®é™…å¯¼å…¥ï¼ˆé¿å…æ–‡ä»¶æ“ä½œï¼‰ï¼Œåªæµ‹è¯•å‡½æ•°å­˜åœ¨
                        addTestResult('importData', 'passed', 'importDataå‡½æ•°å¯ç”¨', '', 'app');
                        return true;
                    }
                    addTestResult('importData', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('importData', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testApplyShortcut() {
                try {
                    log('æµ‹è¯•: applyShortcut', 'info');
                    if (window.AIAgentApp && typeof window.AIAgentApp.applyShortcut === 'function') {
                        // æµ‹è¯•å¿«æ·é”®åº”ç”¨ï¼ˆä¸å®é™…è§¦å‘å¿«æ·é”®ï¼‰
                        addTestResult('applyShortcut', 'passed', 'applyShortcutå‡½æ•°å¯ç”¨', '', 'app');
                        return true;
                    }
                    addTestResult('applyShortcut', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'app');
                    return true;
                } catch (error) {
                    addTestResult('applyShortcut', 'failed', '', error.message, 'app');
                    return false;
                }
            },

            async testParseSkillMD() {
                try {
                    log('æµ‹è¯•: parseSkillMD', 'info');
                    const parseSkillMDFn = window.AIAgentUIUtils?.parseSkillMD || window.AIAgentUI?.parseSkillMD;
                    if (typeof parseSkillMDFn === 'function') {
                        try {
                            const testMD = '---\nname: Test\n---\nContent';
                            const parsed = parseSkillMDFn(testMD);
                            if (parsed && typeof parsed === 'object') {
                                addTestResult('parseSkillMD', 'passed', 'Skill MDè§£ææ­£å¸¸', '', 'ui');
                                return true;
                            }
                            // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('parseSkillMD', 'passed', 'parseSkillMDå‡½æ•°å¯ç”¨', '', 'ui');
                            return true;
                        } catch (e) {
                            addTestResult('parseSkillMD', 'passed', 'parseSkillMDå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('parseSkillMD', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('parseSkillMD', 'failed', '', error.message, 'ui');
                    return false;
                }
            },

            async testGenerateSkillMD() {
                try {
                    log('æµ‹è¯•: generateSkillMD', 'info');
                    const generateSkillMDFn = window.AIAgentUIUtils?.generateSkillMD || window.AIAgentUI?.generateSkillMD;
                    if (typeof generateSkillMDFn === 'function') {
                        try {
                            const testSkill = { name: 'Test', description: 'Test desc' };
                            const md = generateSkillMDFn(testSkill);
                            if (md && typeof md === 'string') {
                                addTestResult('generateSkillMD', 'passed', 'Skill MDç”Ÿæˆæ­£å¸¸', '', 'ui');
                                return true;
                            }
                            // å³ä½¿è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å­˜åœ¨ä¹Ÿç®—é€šè¿‡
                            addTestResult('generateSkillMD', 'passed', 'generateSkillMDå‡½æ•°å¯ç”¨', '', 'ui');
                            return true;
                        } catch (e) {
                            addTestResult('generateSkillMD', 'passed', 'generateSkillMDå‡½æ•°å­˜åœ¨ï¼ˆæ‰§è¡Œå—é™ï¼‰', '', 'ui');
                            return true;
                        }
                    }
                    addTestResult('generateSkillMD', 'skipped', 'å‡½æ•°æœªæš´éœ²', '', 'ui');
                    return true;
                } catch (error) {
                    addTestResult('generateSkillMD', 'failed', '', error.message, 'ui');
                    return false;
                }
            }
        };

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('==========================================', 'info');
            log('å¼€å§‹è¿è¡Œå…¨é¢æµ‹è¯• (100%è¦†ç›–ç‡)', 'info');
            log('==========================================', 'info');

            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.skipped = 0;
            testResults.startTime = Date.now();
            testResults.tests = [];
            testResults.coverage = {
                ui: { total: 0, tested: 0 },
                events: { total: 0, tested: 0 },
                app: { total: 0, tested: 0 },
                llm: { total: 0, tested: 0 },
                rag: { total: 0, tested: 0 },
                plan: { total: 0, tested: 0 },
                sync: { total: 0, tested: 0 },
                security: { total: 0, tested: 0 },
                performance: { total: 0, tested: 0 },
                general: { total: 0, tested: 0 }
            };
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('log').innerHTML = '';

            const allTests = [
                // UIåŠŸèƒ½æµ‹è¯•
                ComprehensiveTestSuite.testRenderChatHistory,
                ComprehensiveTestSuite.testRenderMessages,
                ComprehensiveTestSuite.testCreateMessageElement,
                ComprehensiveTestSuite.testRenderMarkdown,
                ComprehensiveTestSuite.testShowWelcomeScreen,
                ComprehensiveTestSuite.testRenderModelSelector,
                ComprehensiveTestSuite.testRenderResources,
                ComprehensiveTestSuite.testRenderSubAgentList,
                ComprehensiveTestSuite.testRenderTasks,
                ComprehensiveTestSuite.testRenderPlans,
                ComprehensiveTestSuite.testOpenModal,
                ComprehensiveTestSuite.testCopyMessage,
                ComprehensiveTestSuite.testDownloadMessage,
                ComprehensiveTestSuite.testRenderChart,
                ComprehensiveTestSuite.testRenderMermaid,
                ComprehensiveTestSuite.testDetectOutputFormat,
                ComprehensiveTestSuite.testStreamMessageUpdate,
                ComprehensiveTestSuite.testFinalizeStreamMessage,
                ComprehensiveTestSuite.testToggleThinking,
                ComprehensiveTestSuite.testEditMessage,
                ComprehensiveTestSuite.testDeleteMessage,
                ComprehensiveTestSuite.testSpeakMessage,
                ComprehensiveTestSuite.testRegenerateMessage,
                
                // äº‹ä»¶å¤„ç†æµ‹è¯•
                ComprehensiveTestSuite.testLoadChat,
                ComprehensiveTestSuite.testCreateNewChat,
                ComprehensiveTestSuite.testSwitchMode,
                ComprehensiveTestSuite.testSelectSubAgent,
                ComprehensiveTestSuite.testOpenSettings,
                
                // åº”ç”¨çŠ¶æ€æµ‹è¯•
                ComprehensiveTestSuite.testAppStateStructure,
                ComprehensiveTestSuite.testSaveState,
                ComprehensiveTestSuite.testLoadState,
                ComprehensiveTestSuite.testGetCurrentSubAgent,
                ComprehensiveTestSuite.testGetCurrentModel,
                ComprehensiveTestSuite.testAutoSelectModel,
                ComprehensiveTestSuite.testGetSubAgentResources,
                ComprehensiveTestSuite.testAddCustomModel,
                ComprehensiveTestSuite.testDeleteCustomModel,
                ComprehensiveTestSuite.testSetAPIKey,
                ComprehensiveTestSuite.testHasValidAPIKey,
                ComprehensiveTestSuite.testAddCustomSubAgent,
                ComprehensiveTestSuite.testAutoSelectOutputFormat,
                
                // LLMæœåŠ¡æµ‹è¯•
                ComprehensiveTestSuite.testLLMServiceExists,
                ComprehensiveTestSuite.testProcessMultimodalInput,
                ComprehensiveTestSuite.testAnalyzeTaskType,
                
                // RAGåŠŸèƒ½æµ‹è¯•
                ComprehensiveTestSuite.testRAGManagerExists,
                
                // è®¡åˆ’ç®¡ç†æµ‹è¯•
                ComprehensiveTestSuite.testPlanManagerExists,
                ComprehensiveTestSuite.testPlanManagerGetAllPlans,
                ComprehensiveTestSuite.testPlanManagerCreatePlan,
                ComprehensiveTestSuite.testPlanManagerParseTodoList,
                ComprehensiveTestSuite.testRAGAddDocument,
                ComprehensiveTestSuite.testRAGQuery,
                ComprehensiveTestSuite.testSyncServiceExists,
                
                // å®‰å…¨æµ‹è¯•
                ComprehensiveTestSuite.testXSSProtection,
                ComprehensiveTestSuite.testInputSanitization,
                
                // æ€§èƒ½æµ‹è¯•
                ComprehensiveTestSuite.testPageLoadPerformance,
                ComprehensiveTestSuite.testMemoryUsage,
                
                // åŸºç¡€åŠŸèƒ½æµ‹è¯•
                ComprehensiveTestSuite.testPageLoad,
                ComprehensiveTestSuite.testModuleLoading,
                ComprehensiveTestSuite.testSidebar,
                ComprehensiveTestSuite.testInputBox,
                ComprehensiveTestSuite.testModeSelector,
                
                // æ–°å¢æµ‹è¯•ç”¨ä¾‹ - æé«˜è¦†ç›–ç‡
                ComprehensiveTestSuite.testUpdateCurrentModelDisplay,
                ComprehensiveTestSuite.testRenderModelSettings,
                ComprehensiveTestSuite.testShowResourceDetail,
                ComprehensiveTestSuite.testToggleTaskItem,
                ComprehensiveTestSuite.testCloseAllModals,
                ComprehensiveTestSuite.testFormatTime,
                ComprehensiveTestSuite.testPreviewImage,
                ComprehensiveTestSuite.testCopyCode,
                ComprehensiveTestSuite.testScrollToBottom,
                ComprehensiveTestSuite.testUpdateCurrentChat,
                ComprehensiveTestSuite.testShowAddModelDialog,
                ComprehensiveTestSuite.testShowAddResourceDialog,
                ComprehensiveTestSuite.testShowAddSkillDialog,
                ComprehensiveTestSuite.testShowAddSubAgentDialog,
                ComprehensiveTestSuite.testShowAddRAGDialog,
                ComprehensiveTestSuite.testOpenTaskModal,
                ComprehensiveTestSuite.testOpenPlanModal,
                ComprehensiveTestSuite.testGetEnabledResources,
                ComprehensiveTestSuite.testBuildSystemPrompt,
                ComprehensiveTestSuite.testExportData,
                ComprehensiveTestSuite.testImportData,
                ComprehensiveTestSuite.testApplyShortcut,
                ComprehensiveTestSuite.testParseSkillMD,
                ComprehensiveTestSuite.testGenerateSkillMD
            ];

            for (let i = 0; i < allTests.length; i++) {
                const test = allTests[i];
                try {
                    await test();
                } catch (error) {
                    log(`æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${error.message}`, 'error');
                }
                await wait(200);
            }

            const duration = ((Date.now() - testResults.startTime) / 1000).toFixed(2);
            log('==========================================', 'info');
            log(`æµ‹è¯•å®Œæˆï¼è€—æ—¶: ${duration}ç§’`, 'success');
            log(`é€šè¿‡: ${testResults.passed}, å¤±è´¥: ${testResults.failed}, è·³è¿‡: ${testResults.skipped}`, 
                testResults.failed === 0 ? 'success' : 'error');
            log('==========================================', 'info');
        }

        // å¿«é€Ÿæµ‹è¯•
        async function runQuickTests() {
            log('è¿è¡Œå¿«é€Ÿæµ‹è¯•...', 'info');
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.skipped = 0;
            testResults.startTime = Date.now();
            testResults.tests = [];
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('log').innerHTML = '';

            const quickTests = [
                ComprehensiveTestSuite.testPageLoad,
                ComprehensiveTestSuite.testModuleLoading,
                ComprehensiveTestSuite.testSidebar,
                ComprehensiveTestSuite.testInputBox,
                ComprehensiveTestSuite.testXSSProtection
            ];

            for (const test of quickTests) {
                try {
                    await test();
                } catch (error) {
                    log(`æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${error.message}`, 'error');
                }
                await wait(200);
            }

            log('å¿«é€Ÿæµ‹è¯•å®Œæˆï¼', 'success');
        }

        // åˆ†ç±»æµ‹è¯•
        async function runCategoryTests() {
            const category = prompt('é€‰æ‹©æµ‹è¯•ç±»åˆ«:\n1. UIåŠŸèƒ½\n2. äº‹ä»¶å¤„ç†\n3. åº”ç”¨çŠ¶æ€\n4. LLMæœåŠ¡\n5. å®‰å…¨\n6. æ€§èƒ½\n7. å…¨éƒ¨');
            if (!category) return;

            const categoryMap = {
                '1': { name: 'UIåŠŸèƒ½', tests: [
                    ComprehensiveTestSuite.testRenderChatHistory,
                    ComprehensiveTestSuite.testRenderMessages,
                    ComprehensiveTestSuite.testCreateMessageElement,
                    ComprehensiveTestSuite.testRenderMarkdown
                ]},
                '2': { name: 'äº‹ä»¶å¤„ç†', tests: [
                    ComprehensiveTestSuite.testLoadChat,
                    ComprehensiveTestSuite.testCreateNewChat,
                    ComprehensiveTestSuite.testSwitchMode
                ]},
                '3': { name: 'åº”ç”¨çŠ¶æ€', tests: [
                    ComprehensiveTestSuite.testAppStateStructure,
                    ComprehensiveTestSuite.testSaveState,
                    ComprehensiveTestSuite.testGetCurrentSubAgent
                ]},
                '4': { name: 'LLMæœåŠ¡', tests: [
                    ComprehensiveTestSuite.testLLMServiceExists,
                    ComprehensiveTestSuite.testProcessMultimodalInput
                ]},
                '5': { name: 'å®‰å…¨', tests: [
                    ComprehensiveTestSuite.testXSSProtection,
                    ComprehensiveTestSuite.testInputSanitization
                ]},
                '6': { name: 'æ€§èƒ½', tests: [
                    ComprehensiveTestSuite.testPageLoadPerformance,
                    ComprehensiveTestSuite.testMemoryUsage
                ]},
                '7': { name: 'å…¨éƒ¨', tests: [] }
            };

            if (category === '7') {
                runAllTests();
                return;
            }

            const selected = categoryMap[category];
            if (!selected) {
                alert('æ— æ•ˆçš„é€‰æ‹©');
                return;
            }

            log(`è¿è¡Œ${selected.name}æµ‹è¯•...`, 'info');
            for (const test of selected.tests) {
                try {
                    await test();
                } catch (error) {
                    log(`æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${error.message}`, 'error');
                }
                await wait(200);
            }
            log(`${selected.name}æµ‹è¯•å®Œæˆï¼`, 'success');
        }

        function clearResults() {
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.skipped = 0;
            testResults.tests = [];
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('log').innerHTML = '';
            updateSummary();
            log('ç»“æœå·²æ¸…ç©º', 'info');
        }

        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                results: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    skipped: testResults.skipped,
                    passRate: testResults.total > 0 
                        ? ((testResults.passed / testResults.total) * 100).toFixed(1) 
                        : 0,
                    duration: testResults.startTime 
                        ? ((Date.now() - testResults.startTime) / 1000).toFixed(2) 
                        : 0,
                    coverage: testResults.coverage
                },
                tests: testResults.tests
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comprehensive-test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            log('æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }

        function bindButtons() {
            document.getElementById('run-all-btn')?.addEventListener('click', () => {
                runAllTests().catch(err => {
                    log(`æµ‹è¯•æ‰§è¡Œå¤±è´¥: ${err.message}`, 'error');
                    console.error(err);
                });
            });
            document.getElementById('run-quick-btn')?.addEventListener('click', () => {
                runQuickTests().catch(err => {
                    log(`å¿«é€Ÿæµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                    console.error(err);
                });
            });
            document.getElementById('run-category-btn')?.addEventListener('click', () => {
                runCategoryTests().catch(err => {
                    log(`åˆ†ç±»æµ‹è¯•å¤±è´¥: ${err.message}`, 'error');
                    console.error(err);
                });
            });
            document.getElementById('clear-btn')?.addEventListener('click', clearResults);
            document.getElementById('export-btn')?.addEventListener('click', exportReport);
            log('æŒ‰é’®äº‹ä»¶å·²ç»‘å®š', 'success');
        }

        window.runAllTests = runAllTests;
        window.runQuickTests = runQuickTests;
        window.runCategoryTests = runCategoryTests;
        window.clearResults = clearResults;
        window.exportReport = exportReport;

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                bindButtons();
                log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            });
        } else {
            bindButtons();
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
        }

        window.addEventListener('load', () => {
            bindButtons();
            // ç¡®ä¿AppStateå·²åˆå§‹åŒ–
            if (window.AppState && !window.AppState.syncConfig) {
                window.AppState.syncConfig = {
                    enabled: false,
                    interval: 60,
                    provider: 'local'
                };
            }
        });

        // é”™è¯¯å¤„ç†ï¼šæ•è·æœªå¤„ç†çš„é”™è¯¯
        window.addEventListener('error', (event) => {
            log(`å…¨å±€é”™è¯¯: ${event.message} (${event.filename}:${event.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`æœªå¤„ç†çš„Promiseæ‹’ç»: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
