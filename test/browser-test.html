<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Pro è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #00D4FF, #B829F7);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .controls {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00D4FF, #B829F7);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,212,255,0.4); }
        .btn-success { background: #00E676; color: white; }
        .btn-danger { background: #FF1744; color: white; }
        .btn-secondary { background: #424242; color: white; }
        .results {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .test-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #0f1624;
        }
        .test-item.passed { border-color: #00E676; }
        .test-item.failed { border-color: #FF1744; }
        .test-item.running { border-color: #FFD600; }
        .test-item.skipped { border-color: #999; }
        .test-name { font-weight: 600; margin-bottom: 5px; }
        .test-details { font-size: 13px; color: #aaa; margin-top: 5px; }
        .test-error { color: #FF1744; margin-top: 5px; }
        .summary {
            background: #16213e;
            padding: 20px;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            background: #0f1624;
            border-radius: 8px;
        }
        .summary-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary-label {
            font-size: 14px;
            color: #aaa;
        }
        .log {
            background: #0a0a0f;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }
        .log-entry.info { color: #00B0FF; }
        .log-entry.success { color: #00E676; }
        .log-entry.error { color: #FF1744; }
        .log-entry.warning { color: #FFD600; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #0f1624;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00D4FF, #B829F7);
            transition: width 0.3s;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI Agent Pro è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶</h1>
            <p>å…¨é¢æ·±å…¥çš„ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="run-all-btn">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="btn btn-success" id="run-quick-btn">âš¡ å¿«é€Ÿæµ‹è¯•</button>
            <button class="btn btn-secondary" id="clear-btn">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            <button class="btn btn-danger" id="export-btn">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
        </div>

        <div class="summary" id="summary">
            <div class="summary-item">
                <div class="summary-label">æ€»æµ‹è¯•æ•°</div>
                <div class="summary-value" id="total">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">é€šè¿‡</div>
                <div class="summary-value" style="color: #00E676;" id="passed">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">å¤±è´¥</div>
                <div class="summary-value" style="color: #FF1744;" id="failed">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è·³è¿‡</div>
                <div class="summary-value" style="color: #999;" id="skipped">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">é€šè¿‡ç‡</div>
                <div class="summary-value" id="passRate">0%</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è€—æ—¶</div>
                <div class="summary-value" id="duration">0s</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div class="results" id="results"></div>

        <div class="results">
            <h3 style="margin-bottom: 15px;">ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç»“æœ
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            skipped: 0,
            startTime: null,
            tests: []
        };

        // å·¥å…·å‡½æ•°
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateSummary() {
            document.getElementById('total').textContent = testResults.total;
            document.getElementById('passed').textContent = testResults.passed;
            document.getElementById('failed').textContent = testResults.failed;
            document.getElementById('skipped').textContent = testResults.skipped;
            const passRate = testResults.total > 0 
                ? ((testResults.passed / testResults.total) * 100).toFixed(1) 
                : 0;
            document.getElementById('passRate').textContent = passRate + '%';
            const duration = testResults.startTime 
                ? ((Date.now() - testResults.startTime) / 1000).toFixed(2) 
                : 0;
            document.getElementById('duration').textContent = duration + 's';
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = testResults.total > 0 
                ? ((testResults.passed + testResults.failed + testResults.skipped) / testResults.total) * 100 
                : 0;
            document.getElementById('progress').style.width = progress + '%';
        }

        function addTestResult(name, status, details = '', error = '') {
            testResults.total++;
            if (status === 'passed') testResults.passed++;
            else if (status === 'failed') testResults.failed++;
            else if (status === 'skipped') testResults.skipped++;

            testResults.tests.push({ name, status, details, error });

            const resultsEl = document.getElementById('results');
            const item = document.createElement('div');
            item.className = `test-item ${status}`;
            item.innerHTML = `
                <div class="test-name">${status === 'passed' ? 'âœ…' : status === 'failed' ? 'âŒ' : 'â­ï¸'} ${name}</div>
                ${details ? `<div class="test-details">${details}</div>` : ''}
                ${error ? `<div class="test-error">é”™è¯¯: ${error}</div>` : ''}
            `;
            resultsEl.appendChild(item);
            updateSummary();
        }

        // ç­‰å¾…å‡½æ•°
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
        function checkElement(selector, timeout = 5000) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                const check = () => {
                    const el = document.querySelector(selector);
                    if (el) {
                        resolve(el);
                    } else if (Date.now() - startTime < timeout) {
                        setTimeout(check, 100);
                    } else {
                        resolve(null);
                    }
                };
                check();
            });
        }

        // æµ‹è¯•å¥—ä»¶
        const TestSuite = {
            // æµ‹è¯•1: é¡µé¢åŠ è½½å’ŒåŸºç¡€æ£€æŸ¥
            async testPageLoad() {
                try {
                    log('æµ‹è¯•1: é¡µé¢åŠ è½½æ£€æŸ¥', 'info');
                    const title = document.title;
                    if (title.includes('AI Agent Pro')) {
                        addTestResult('é¡µé¢åŠ è½½', 'passed', `æ ‡é¢˜: ${title}`);
                        return true;
                    } else {
                        throw new Error(`æ ‡é¢˜ä¸æ­£ç¡®: ${title}`);
                    }
                } catch (error) {
                    addTestResult('é¡µé¢åŠ è½½', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•2: æ¨¡å—åŠ è½½æ£€æŸ¥
            async testModuleLoading() {
                try {
                    log('æµ‹è¯•2: æ¨¡å—åŠ è½½æ£€æŸ¥', 'info');
                    const modules = {
                        Logger: typeof window.Logger !== 'undefined',
                        ErrorHandler: typeof window.ErrorHandler !== 'undefined',
                        EventManager: typeof window.EventManager !== 'undefined',
                        AIAgentUIUtils: typeof window.AIAgentUIUtils !== 'undefined',
                        AIAgentApp: typeof window.AIAgentApp !== 'undefined',
                        AIAgentUI: typeof window.AIAgentUI !== 'undefined',
                        AppState: typeof window.AppState !== 'undefined'
                    };

                    const missing = Object.entries(modules)
                        .filter(([name, loaded]) => !loaded)
                        .map(([name]) => name);

                    if (missing.length === 0) {
                        addTestResult('æ¨¡å—åŠ è½½', 'passed', 'æ‰€æœ‰æ¨¡å—å·²åŠ è½½');
                        return true;
                    } else {
                        throw new Error(`æœªåŠ è½½çš„æ¨¡å—: ${missing.join(', ')}`);
                    }
                } catch (error) {
                    addTestResult('æ¨¡å—åŠ è½½', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•3: å¯åŠ¨é¡µåŠŸèƒ½
            async testSplashScreen() {
                try {
                    log('æµ‹è¯•3: å¯åŠ¨é¡µæ£€æŸ¥', 'info');
                    const splash = await checkElement('#splash', 2000);
                    if (splash) {
                        const isVisible = window.getComputedStyle(splash).display !== 'none';
                        await wait(3000); // ç­‰å¾…å¯åŠ¨é¡µæ¶ˆå¤±
                        addTestResult('å¯åŠ¨é¡µæ˜¾ç¤º', 'passed', 'å¯åŠ¨é¡µæ­£å¸¸æ˜¾ç¤ºå¹¶æ¶ˆå¤±');
                        return true;
                    } else {
                        addTestResult('å¯åŠ¨é¡µæ˜¾ç¤º', 'skipped', 'å¯åŠ¨é¡µå·²æ¶ˆå¤±æˆ–ä¸å­˜åœ¨');
                        return true;
                    }
                } catch (error) {
                    addTestResult('å¯åŠ¨é¡µæ˜¾ç¤º', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•4: ä¾§è¾¹æ åŠŸèƒ½
            async testSidebar() {
                try {
                    log('æµ‹è¯•4: ä¾§è¾¹æ åŠŸèƒ½', 'info');
                    const menuBtn = await checkElement('#menu-btn');
                    if (!menuBtn) throw new Error('æœªæ‰¾åˆ°èœå•æŒ‰é’®');

                    menuBtn.click();
                    await wait(500);

                    const sidebar = await checkElement('#sidebar');
                    if (!sidebar) throw new Error('ä¾§è¾¹æ æœªæ˜¾ç¤º');

                    const isVisible = window.getComputedStyle(sidebar).display !== 'none';
                    if (!isVisible) throw new Error('ä¾§è¾¹æ ä¸å¯è§');

                    addTestResult('ä¾§è¾¹æ æ‰“å¼€', 'passed');

                    const closeBtn = await checkElement('#close-sidebar');
                    if (closeBtn) {
                        closeBtn.click();
                        await wait(500);
                        addTestResult('ä¾§è¾¹æ å…³é—­', 'passed');
                    }

                    return true;
                } catch (error) {
                    addTestResult('ä¾§è¾¹æ åŠŸèƒ½', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•5: å¯¹è¯å†å²
            async testChatHistory() {
                try {
                    log('æµ‹è¯•5: å¯¹è¯å†å²', 'info');
                    const menuBtn = await checkElement('#menu-btn');
                    if (menuBtn) {
                        menuBtn.click();
                        await wait(500);
                    }

                    const chatHistory = await checkElement('#chat-history');
                    if (chatHistory) {
                        const chats = window.AppState?.chats || [];
                        addTestResult('å¯¹è¯å†å²', 'passed', `æ‰¾åˆ° ${chats.length} ä¸ªå¯¹è¯`);
                        return true;
                    } else {
                        throw new Error('æœªæ‰¾åˆ°å¯¹è¯å†å²å®¹å™¨');
                    }
                } catch (error) {
                    addTestResult('å¯¹è¯å†å²', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•6: æ–°å»ºå¯¹è¯
            async testNewChat() {
                try {
                    log('æµ‹è¯•6: æ–°å»ºå¯¹è¯', 'info');
                    const menuBtn = await checkElement('#menu-btn');
                    if (menuBtn) {
                        menuBtn.click();
                        await wait(500);
                    }

                    const newChatBtn = await checkElement('#new-chat-btn');
                    if (!newChatBtn) throw new Error('æœªæ‰¾åˆ°æ–°å»ºå¯¹è¯æŒ‰é’®');

                    newChatBtn.click();
                    await wait(1000);

                    const welcomeScreen = await checkElement('#welcome-screen');
                    if (welcomeScreen) {
                        const isVisible = window.getComputedStyle(welcomeScreen).display !== 'none';
                        if (isVisible) {
                            addTestResult('æ–°å»ºå¯¹è¯', 'passed', 'æ¬¢è¿é¡µé¢æ˜¾ç¤ºæ­£å¸¸');
                            return true;
                        }
                    }
                    throw new Error('æ¬¢è¿é¡µé¢æœªæ˜¾ç¤º');
                } catch (error) {
                    addTestResult('æ–°å»ºå¯¹è¯', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•7: è¾“å…¥æ¡†åŠŸèƒ½
            async testInputBox() {
                try {
                    log('æµ‹è¯•7: è¾“å…¥æ¡†åŠŸèƒ½', 'info');
                    const input = await checkElement('#message-input');
                    if (!input) throw new Error('æœªæ‰¾åˆ°è¾“å…¥æ¡†');

                    input.focus();
                    input.value = 'æµ‹è¯•æ¶ˆæ¯';
                    input.dispatchEvent(new Event('input', { bubbles: true }));

                    await wait(500);

                    if (input.value === 'æµ‹è¯•æ¶ˆæ¯') {
                        addTestResult('è¾“å…¥æ¡†åŠŸèƒ½', 'passed', 'è¾“å…¥å’Œäº‹ä»¶æ­£å¸¸');
                        input.value = ''; // æ¸…ç©º
                        return true;
                    } else {
                        throw new Error('è¾“å…¥å€¼ä¸åŒ¹é…');
                    }
                } catch (error) {
                    addTestResult('è¾“å…¥æ¡†åŠŸèƒ½', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•8: æ¨¡å¼é€‰æ‹©å™¨
            async testModeSelector() {
                try {
                    log('æµ‹è¯•8: æ¨¡å¼é€‰æ‹©å™¨', 'info');
                    const modeOptions = document.querySelectorAll('.mode-option');
                    if (modeOptions.length === 0) throw new Error('æœªæ‰¾åˆ°æ¨¡å¼é€‰æ‹©å™¨');

                    // æµ‹è¯•åˆ‡æ¢åˆ°ä»»åŠ¡æ¨¡å¼
                    if (modeOptions.length > 1) {
                        modeOptions[1].click();
                        await wait(500);

                        const isActive = modeOptions[1].classList.contains('active');
                        if (isActive) {
                            addTestResult('æ¨¡å¼é€‰æ‹©å™¨', 'passed', `æ‰¾åˆ° ${modeOptions.length} ä¸ªæ¨¡å¼é€‰é¡¹`);
                            
                            // åˆ‡å›å¯¹è¯æ¨¡å¼
                            modeOptions[0].click();
                            await wait(500);
                            return true;
                        } else {
                            throw new Error('æ¨¡å¼åˆ‡æ¢å¤±è´¥');
                        }
                    } else {
                        throw new Error('æ¨¡å¼é€‰é¡¹ä¸è¶³');
                    }
                } catch (error) {
                    addTestResult('æ¨¡å¼é€‰æ‹©å™¨', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•9: æ¨¡å‹é€‰æ‹©å™¨
            async testModelSelector() {
                try {
                    log('æµ‹è¯•9: æ¨¡å‹é€‰æ‹©å™¨', 'info');
                    const modelBtn = await checkElement('#model-selector-btn');
                    if (!modelBtn) throw new Error('æœªæ‰¾åˆ°æ¨¡å‹é€‰æ‹©å™¨æŒ‰é’®');

                    modelBtn.click();
                    await wait(1000);

                    const modelModal = await checkElement('#model-modal');
                    if (modelModal) {
                        const isVisible = window.getComputedStyle(modelModal).display !== 'none' &&
                                         modelModal.classList.contains('active');
                        if (isVisible) {
                            addTestResult('æ¨¡å‹é€‰æ‹©å™¨', 'passed', 'æ¨¡å‹é€‰æ‹©æ¨¡æ€æ¡†æ­£å¸¸æ˜¾ç¤º');
                            
                            // å…³é—­æ¨¡æ€æ¡†
                            const closeBtn = modelModal.querySelector('.modal-close');
                            if (closeBtn) {
                                closeBtn.click();
                                await wait(500);
                            }
                            return true;
                        }
                    }
                    throw new Error('æ¨¡å‹é€‰æ‹©æ¨¡æ€æ¡†æœªæ˜¾ç¤º');
                } catch (error) {
                    addTestResult('æ¨¡å‹é€‰æ‹©å™¨', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•10: è®¾ç½®æ¨¡æ€æ¡†
            async testSettingsModal() {
                try {
                    log('æµ‹è¯•10: è®¾ç½®æ¨¡æ€æ¡†', 'info');
                    const menuBtn = await checkElement('#menu-btn');
                    if (menuBtn) {
                        menuBtn.click();
                        await wait(500);
                    }

                    const settingsBtn = await checkElement('#settings-btn');
                    if (!settingsBtn) throw new Error('æœªæ‰¾åˆ°è®¾ç½®æŒ‰é’®');

                    settingsBtn.click();
                    await wait(1000);

                    const settingsModal = await checkElement('#settings-modal');
                    if (settingsModal) {
                        const isVisible = window.getComputedStyle(settingsModal).display !== 'none' &&
                                         settingsModal.classList.contains('active');
                        if (isVisible) {
                            // æµ‹è¯•è®¾ç½®æ ‡ç­¾åˆ‡æ¢
                            const menuItems = settingsModal.querySelectorAll('.settings-menu-item');
                            if (menuItems.length > 0) {
                                menuItems[1].click();
                                await wait(500);
                                addTestResult('è®¾ç½®æ¨¡æ€æ¡†', 'passed', `æ‰¾åˆ° ${menuItems.length} ä¸ªè®¾ç½®æ ‡ç­¾`);
                            } else {
                                addTestResult('è®¾ç½®æ¨¡æ€æ¡†', 'passed', 'è®¾ç½®æ¨¡æ€æ¡†æ­£å¸¸æ˜¾ç¤º');
                            }

                            // å…³é—­æ¨¡æ€æ¡†
                            const closeBtn = settingsModal.querySelector('.modal-close');
                            if (closeBtn) {
                                closeBtn.click();
                                await wait(500);
                            }
                            return true;
                        }
                    }
                    throw new Error('è®¾ç½®æ¨¡æ€æ¡†æœªæ˜¾ç¤º');
                } catch (error) {
                    addTestResult('è®¾ç½®æ¨¡æ€æ¡†', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•11: SubAgenté€‰æ‹©å™¨
            async testSubAgentSelector() {
                try {
                    log('æµ‹è¯•11: SubAgenté€‰æ‹©å™¨', 'info');
                    const subagentBtn = await checkElement('#subagent-btn');
                    if (!subagentBtn) {
                        addTestResult('SubAgenté€‰æ‹©å™¨', 'skipped', 'SubAgentæŒ‰é’®æœªæ‰¾åˆ°ï¼ˆå¯èƒ½åœ¨å·¥å…·æ ä¸­ï¼‰');
                        return true;
                    }

                    subagentBtn.click();
                    await wait(1000);

                    const subagentModal = await checkElement('#subagent-modal');
                    if (subagentModal) {
                        const isVisible = window.getComputedStyle(subagentModal).display !== 'none' &&
                                         subagentModal.classList.contains('active');
                        if (isVisible) {
                            addTestResult('SubAgenté€‰æ‹©å™¨', 'passed', 'SubAgenté€‰æ‹©æ¨¡æ€æ¡†æ­£å¸¸æ˜¾ç¤º');
                            
                            const closeBtn = subagentModal.querySelector('.modal-close');
                            if (closeBtn) {
                                closeBtn.click();
                                await wait(500);
                            }
                            return true;
                        }
                    }
                    throw new Error('SubAgenté€‰æ‹©æ¨¡æ€æ¡†æœªæ˜¾ç¤º');
                } catch (error) {
                    addTestResult('SubAgenté€‰æ‹©å™¨', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•12: å·¥å…·æ æŒ‰é’®
            async testToolbarButtons() {
                try {
                    log('æµ‹è¯•12: å·¥å…·æ æŒ‰é’®', 'info');
                    const buttons = [
                        { id: 'upload-btn', name: 'æ–‡ä»¶ä¸Šä¼ ' },
                        { id: 'image-btn', name: 'å›¾ç‰‡ä¸Šä¼ ' },
                        { id: 'voice-btn', name: 'è¯­éŸ³è¾“å…¥' },
                        { id: 'search-btn', name: 'ç½‘ç»œæœç´¢' },
                        { id: 'tools-btn', name: 'å·¥å…·ç®±' },
                        { id: 'clear-btn', name: 'æ¸…ç©ºå¯¹è¯' }
                    ];

                    let found = 0;
                    for (const btn of buttons) {
                        const element = await checkElement(`#${btn.id}`, 1000);
                        if (element) {
                            found++;
                            // æµ‹è¯•ç‚¹å‡»ï¼ˆä¸å®é™…æ‰§è¡Œæ“ä½œï¼‰
                            try {
                                element.click();
                                await wait(200);
                            } catch (e) {
                                // å¿½ç•¥ç‚¹å‡»é”™è¯¯
                            }
                        }
                    }

                    if (found > 0) {
                        addTestResult('å·¥å…·æ æŒ‰é’®', 'passed', `æ‰¾åˆ° ${found}/${buttons.length} ä¸ªå·¥å…·æ æŒ‰é’®`);
                        return true;
                    } else {
                        throw new Error('æœªæ‰¾åˆ°ä»»ä½•å·¥å…·æ æŒ‰é’®');
                    }
                } catch (error) {
                    addTestResult('å·¥å…·æ æŒ‰é’®', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•13: JavaScripté”™è¯¯æ£€æŸ¥
            async testJavaScriptErrors() {
                try {
                    log('æµ‹è¯•13: JavaScripté”™è¯¯æ£€æŸ¥', 'info');
                    // æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ï¼ˆé€šè¿‡window.onerrorï¼‰
                    const errors = [];
                    const originalError = window.onerror;
                    
                    window.onerror = (msg, url, line, col, err) => {
                        // è¿‡æ»¤æ‰é¢„æœŸçš„é”™è¯¯
                        if (!msg.includes('favicon') && 
                            !msg.includes('net::') &&
                            !msg.includes('Failed to fetch') &&
                            !msg.includes('CORS')) {
                            errors.push(msg);
                        }
                        if (originalError) originalError(msg, url, line, col, err);
                    };

                    await wait(2000); // ç­‰å¾…å¯èƒ½çš„é”™è¯¯

                    window.onerror = originalError;

                    if (errors.length === 0) {
                        addTestResult('JavaScripté”™è¯¯æ£€æŸ¥', 'passed', 'æœªå‘ç°å…³é”®é”™è¯¯');
                        return true;
                    } else {
                        throw new Error(`å‘ç° ${errors.length} ä¸ªé”™è¯¯: ${errors.join('; ')}`);
                    }
                } catch (error) {
                    addTestResult('JavaScripté”™è¯¯æ£€æŸ¥', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•14: å“åº”å¼è®¾è®¡
            async testResponsiveDesign() {
                try {
                    log('æµ‹è¯•14: å“åº”å¼è®¾è®¡', 'info');
                    const viewports = [
                        { width: 1920, height: 1080, name: 'æ¡Œé¢' },
                        { width: 768, height: 1024, name: 'å¹³æ¿' },
                        { width: 375, height: 667, name: 'æ‰‹æœº' }
                    ];

                    for (const vp of viewports) {
                        // é€šè¿‡CSSåª’ä½“æŸ¥è¯¢æ¨¡æ‹Ÿï¼ˆå®é™…æµ‹è¯•ä¸­éœ€è¦è°ƒæ•´çª—å£å¤§å°ï¼‰
                        const body = document.body;
                        if (!body) throw new Error('bodyå…ƒç´ ä¸å­˜åœ¨');
                    }

                    addTestResult('å“åº”å¼è®¾è®¡', 'passed', 'åŸºç¡€å“åº”å¼æ£€æŸ¥é€šè¿‡');
                    return true;
                } catch (error) {
                    addTestResult('å“åº”å¼è®¾è®¡', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•15: æ•°æ®æŒä¹…åŒ–
            async testDataPersistence() {
                try {
                    log('æµ‹è¯•15: æ•°æ®æŒä¹…åŒ–', 'info');
                    const appState = window.AppState;
                    if (!appState) throw new Error('AppStateæœªå®šä¹‰');

                    // æ£€æŸ¥localStorage
                    const storageKeys = Object.keys(localStorage).filter(key => 
                        key.startsWith('ai_agent_')
                    );

                    if (storageKeys.length > 0) {
                        addTestResult('æ•°æ®æŒä¹…åŒ–', 'passed', `æ‰¾åˆ° ${storageKeys.length} ä¸ªå­˜å‚¨é”®`);
                        return true;
                    } else {
                        addTestResult('æ•°æ®æŒä¹…åŒ–', 'skipped', 'æš‚æ— å­˜å‚¨æ•°æ®ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰');
                        return true;
                    }
                } catch (error) {
                    addTestResult('æ•°æ®æŒä¹…åŒ–', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•16: UIå·¥å…·å‡½æ•°
            async testUIUtils() {
                try {
                    log('æµ‹è¯•16: UIå·¥å…·å‡½æ•°', 'info');
                    const utils = window.AIAgentUIUtils || window.AIAgentUI;
                    if (!utils) throw new Error('UIå·¥å…·æœªåŠ è½½');

                    const functions = ['escapeHtml', 'formatTime', 'showToast', 'scrollToBottom'];
                    const available = functions.filter(fn => typeof utils[fn] === 'function');

                    if (available.length === functions.length) {
                        // æµ‹è¯•escapeHtml
                        const testHtml = '<' + 'script' + '>alert("xss")<' + '/script' + '>';
                        const escaped = utils.escapeHtml(testHtml);
                        if (escaped.includes('&lt;')) {
                            addTestResult('UIå·¥å…·å‡½æ•°', 'passed', `æ‰€æœ‰å·¥å…·å‡½æ•°å¯ç”¨ï¼ŒXSSé˜²æŠ¤æ­£å¸¸`);
                            return true;
                        } else {
                            throw new Error('escapeHtmlæœªæ­£ç¡®è½¬ä¹‰');
                        }
                    } else {
                        throw new Error(`ç¼ºå°‘å‡½æ•°: ${functions.filter(f => !available.includes(f)).join(', ')}`);
                    }
                } catch (error) {
                    addTestResult('UIå·¥å…·å‡½æ•°', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•17: é”™è¯¯å¤„ç†æ¨¡å—
            async testErrorHandler() {
                try {
                    log('æµ‹è¯•17: é”™è¯¯å¤„ç†æ¨¡å—', 'info');
                    const handler = window.ErrorHandler;
                    if (!handler) throw new Error('ErrorHandleræœªåŠ è½½');

                    if (typeof handler.handle === 'function' && 
                        typeof handler.withRetry === 'function') {
                        addTestResult('é”™è¯¯å¤„ç†æ¨¡å—', 'passed', 'é”™è¯¯å¤„ç†åŠŸèƒ½å®Œæ•´');
                        return true;
                    } else {
                        throw new Error('ErrorHandleræ–¹æ³•ä¸å®Œæ•´');
                    }
                } catch (error) {
                    addTestResult('é”™è¯¯å¤„ç†æ¨¡å—', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•18: æ—¥å¿—æ¨¡å—
            async testLogger() {
                try {
                    log('æµ‹è¯•18: æ—¥å¿—æ¨¡å—', 'info');
                    const logger = window.Logger;
                    if (!logger) throw new Error('LoggeræœªåŠ è½½');

                    const methods = ['debug', 'info', 'warn', 'error'];
                    const available = methods.filter(m => typeof logger[m] === 'function');

                    if (available.length === methods.length) {
                        addTestResult('æ—¥å¿—æ¨¡å—', 'passed', 'æ‰€æœ‰æ—¥å¿—æ–¹æ³•å¯ç”¨');
                        return true;
                    } else {
                        throw new Error(`ç¼ºå°‘æ–¹æ³•: ${methods.filter(m => !available.includes(m)).join(', ')}`);
                    }
                } catch (error) {
                    addTestResult('æ—¥å¿—æ¨¡å—', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•19: äº‹ä»¶ç®¡ç†å™¨
            async testEventManager() {
                try {
                    log('æµ‹è¯•19: äº‹ä»¶ç®¡ç†å™¨', 'info');
                    const manager = window.EventManager;
                    if (!manager) throw new Error('EventManageræœªåŠ è½½');

                    if (typeof manager.on === 'function' && 
                        typeof manager.off === 'function' &&
                        typeof manager.removeAll === 'function') {
                        addTestResult('äº‹ä»¶ç®¡ç†å™¨', 'passed', 'äº‹ä»¶ç®¡ç†åŠŸèƒ½å®Œæ•´');
                        return true;
                    } else {
                        throw new Error('EventManageræ–¹æ³•ä¸å®Œæ•´');
                    }
                } catch (error) {
                    addTestResult('äº‹ä»¶ç®¡ç†å™¨', 'failed', '', error.message);
                    return false;
                }
            },

            // æµ‹è¯•20: æ€§èƒ½æ£€æŸ¥
            async testPerformance() {
                try {
                    log('æµ‹è¯•20: æ€§èƒ½æ£€æŸ¥', 'info');
                    const perf = window.performance;
                    if (!perf) throw new Error('Performance APIä¸å¯ç”¨');

                    const navigation = perf.getEntriesByType('navigation')[0];
                    if (navigation) {
                        const loadTime = navigation.loadEventEnd - navigation.fetchStart;
                        const domReady = navigation.domContentLoadedEventEnd - navigation.fetchStart;

                        if (loadTime < 10000) { // 10ç§’å†…åŠ è½½
                            addTestResult('æ€§èƒ½æ£€æŸ¥', 'passed', 
                                `é¡µé¢åŠ è½½: ${(loadTime/1000).toFixed(2)}s, DOMå°±ç»ª: ${(domReady/1000).toFixed(2)}s`);
                            return true;
                        } else {
                            throw new Error(`é¡µé¢åŠ è½½è¿‡æ…¢: ${(loadTime/1000).toFixed(2)}s`);
                        }
                    } else {
                        addTestResult('æ€§èƒ½æ£€æŸ¥', 'skipped', 'Performance APIæ•°æ®ä¸å¯ç”¨');
                        return true;
                    }
                } catch (error) {
                    addTestResult('æ€§èƒ½æ£€æŸ¥', 'failed', '', error.message);
                    return false;
                }
            }
        };

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            log('==========================================', 'info');
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•', 'info');
            log('==========================================', 'info');

            // é‡ç½®ç»“æœ
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.skipped = 0;
            testResults.startTime = Date.now();
            testResults.tests = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('log').innerHTML = '';

            const tests = [
                TestSuite.testPageLoad,
                TestSuite.testModuleLoading,
                TestSuite.testSplashScreen,
                TestSuite.testSidebar,
                TestSuite.testChatHistory,
                TestSuite.testNewChat,
                TestSuite.testInputBox,
                TestSuite.testModeSelector,
                TestSuite.testModelSelector,
                TestSuite.testSettingsModal,
                TestSuite.testSubAgentSelector,
                TestSuite.testToolbarButtons,
                TestSuite.testJavaScriptErrors,
                TestSuite.testResponsiveDesign,
                TestSuite.testDataPersistence,
                TestSuite.testUIUtils,
                TestSuite.testErrorHandler,
                TestSuite.testLogger,
                TestSuite.testEventManager,
                TestSuite.testPerformance
            ];

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                try {
                    await test();
                } catch (error) {
                    log(`æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${error.message}`, 'error');
                }
                await wait(300); // æµ‹è¯•é—´éš”
            }

            const duration = ((Date.now() - testResults.startTime) / 1000).toFixed(2);
            log('==========================================', 'info');
            log(`æµ‹è¯•å®Œæˆï¼è€—æ—¶: ${duration}ç§’`, 'success');
            log(`é€šè¿‡: ${testResults.passed}, å¤±è´¥: ${testResults.failed}, è·³è¿‡: ${testResults.skipped}`, 
                testResults.failed === 0 ? 'success' : 'error');
            log('==========================================', 'info');
        }

        // å¿«é€Ÿæµ‹è¯•
        async function runQuickTests() {
            log('è¿è¡Œå¿«é€Ÿæµ‹è¯•...', 'info');
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.skipped = 0;
            testResults.startTime = Date.now();
            testResults.tests = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('log').innerHTML = '';

            const quickTests = [
                TestSuite.testPageLoad,
                TestSuite.testModuleLoading,
                TestSuite.testSidebar,
                TestSuite.testInputBox,
                TestSuite.testJavaScriptErrors
            ];

            for (const test of quickTests) {
                try {
                    await test();
                } catch (error) {
                    log(`æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: ${error.message}`, 'error');
                }
                await wait(200);
            }

            log('å¿«é€Ÿæµ‹è¯•å®Œæˆï¼', 'success');
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            testResults.total = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.skipped = 0;
            testResults.tests = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('log').innerHTML = '';
            updateSummary();
            log('ç»“æœå·²æ¸…ç©º', 'info');
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                results: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    skipped: testResults.skipped,
                    passRate: testResults.total > 0 
                        ? ((testResults.passed / testResults.total) * 100).toFixed(1) 
                        : 0,
                    duration: testResults.startTime 
                        ? ((Date.now() - testResults.startTime) / 1000).toFixed(2) 
                        : 0
                },
                tests: testResults.tests
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            log('æµ‹è¯•æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œæ›´å¯é ï¼‰
        function bindButtons() {
            const runAllBtn = document.getElementById('run-all-btn');
            const runQuickBtn = document.getElementById('run-quick-btn');
            const clearBtn = document.getElementById('clear-btn');
            const exportBtn = document.getElementById('export-btn');

            if (runAllBtn) {
                runAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    log('ç‚¹å‡»äº†"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®', 'info');
                    runAllTests().catch(err => {
                        log(`æµ‹è¯•æ‰§è¡Œå¤±è´¥: ${err.message}`, 'error');
                        console.error('æµ‹è¯•æ‰§è¡Œé”™è¯¯:', err);
                    });
                });
            }

            if (runQuickBtn) {
                runQuickBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    log('ç‚¹å‡»äº†"å¿«é€Ÿæµ‹è¯•"æŒ‰é’®', 'info');
                    runQuickTests().catch(err => {
                        log(`å¿«é€Ÿæµ‹è¯•æ‰§è¡Œå¤±è´¥: ${err.message}`, 'error');
                        console.error('å¿«é€Ÿæµ‹è¯•é”™è¯¯:', err);
                    });
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    clearResults();
                });
            }

            if (exportBtn) {
                exportBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    exportReport();
                });
            }

            log('æŒ‰é’®äº‹ä»¶å·²ç»‘å®š', 'success');
        }

        // ç¡®ä¿å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆå‘åå…¼å®¹ï¼‰
        window.runAllTests = runAllTests;
        window.runQuickTests = runQuickTests;
        window.clearResults = clearResults;
        window.exportReport = exportReport;

        // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šæŒ‰é’®å’Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                bindButtons();
                log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
                log('ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹å…¨é¢æµ‹è¯•', 'info');
            });
        } else {
            // DOMå·²åŠ è½½ï¼Œç«‹å³ç»‘å®š
            bindButtons();
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹å…¨é¢æµ‹è¯•', 'info');
        }

        // ä¹Ÿç›‘å¬loadäº‹ä»¶ä½œä¸ºå¤‡ç”¨
        window.addEventListener('load', () => {
            bindButtons();
        });
    </script>
</body>
</html>
