<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFè§£æè¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h1 { color: #4a9eff; margin-top: 0; }
        h2 { color: #6ab7ff; margin-top: 20px; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #2a4a2a; border-left: 4px solid #4a9eff; }
        .error { background: #4a2a2a; border-left: 4px solid #ff4a4a; }
        .warning { background: #4a4a2a; border-left: 4px solid #ffaa4a; }
        .info { background: #2a2a4a; border-left: 4px solid #4a9eff; }
        button {
            padding: 10px 20px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #5aaeff; }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #4a4a4a;
            padding-left: 10px;
        }
        .log-info { border-color: #4a9eff; }
        .log-error { border-color: #ff4a4a; }
        .log-warn { border-color: #ffaa4a; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PDFè§£æå®Œæ•´è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·å°†å…¨é¢æ£€æŸ¥PDFè§£æåŠŸèƒ½çš„æ‰€æœ‰ç¯èŠ‚ã€‚</p>
        
        <button onclick="runFullDiagnostic()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <button onclick="testPDFParse()">ğŸ“„ æµ‹è¯•PDFè§£æ</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        
        <div id="results"></div>
    </div>

    <script src="js/utils/logger.js"></script>
    <script src="js/app.js"></script>
    <script src="js/rag.js"></script>

    <script>
        const logs = [];
        
        function log(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ type, timestamp, message, data });
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const resultsDiv = document.getElementById('results');
            let html = '<h2>ğŸ“‹ è¯Šæ–­æ—¥å¿—</h2><div id="log-container"></div>';
            resultsDiv.innerHTML = html;
            
            const logContainer = document.getElementById('log-container');
            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = `log-entry log-${log.type}`;
                div.innerHTML = `<strong>[${log.timestamp}]</strong> ${log.message}`;
                if (log.data) {
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(log.data, null, 2);
                    div.appendChild(pre);
                }
                logContainer.appendChild(div);
            });
        }

        async function runFullDiagnostic() {
            logs.length = 0;
            log('info', 'å¼€å§‹å®Œæ•´è¯Šæ–­...');
            
            // 1. æ£€æŸ¥æ¨¡å—åŠ è½½
            log('info', 'æ£€æŸ¥æ¨¡å—åŠ è½½çŠ¶æ€...');
            const modules = {
                'Logger': typeof window.Logger !== 'undefined',
                'AIAgentApp': typeof window.AIAgentApp !== 'undefined',
                'RAGManager': typeof window.RAGManager !== 'undefined',
                'AIAgentUI': typeof window.AIAgentUI !== 'undefined'
            };
            log('info', 'æ¨¡å—åŠ è½½çŠ¶æ€', modules);
            
            // 2. æ£€æŸ¥Jina AIé…ç½®
            log('info', 'æ£€æŸ¥Jina AIé…ç½®...');
            if (window.AIAgentApp) {
                const apiKey = window.AIAgentApp.getJinaAIKey?.() || '';
                const hasKey = window.AIAgentApp.hasJinaAIKey?.() || false;
                const enabled = window.AIAgentApp.isJinaAIEnabled?.() || false;
                
                log('info', 'Jina AIé…ç½®', {
                    apiKey: apiKey ? `${apiKey.substring(0, 30)}...` : 'æœªé…ç½®',
                    hasKey,
                    enabled,
                    keyLength: apiKey.length
                });
                
                if (!hasKey) {
                    log('error', 'âŒ Jina AI APIå¯†é’¥æœªé…ç½®ï¼');
                } else if (!enabled) {
                    log('error', 'âŒ Jina AIå·²ç¦ç”¨ï¼');
                } else {
                    log('success', 'âœ… Jina AIé…ç½®æ­£å¸¸');
                }
            } else {
                log('error', 'âŒ AIAgentAppæœªåŠ è½½ï¼');
            }
            
            // 3. æ£€æŸ¥RAGManageræ–¹æ³•
            log('info', 'æ£€æŸ¥RAGManageræ–¹æ³•...');
            if (window.RAGManager) {
                const methods = {
                    'parsePDF': typeof window.RAGManager.parsePDF === 'function',
                    'isJinaAIAvailable': typeof window.RAGManager.isJinaAIAvailable === 'function',
                    'getJinaAIKey': typeof window.RAGManager.getJinaAIKey === 'function'
                };
                log('info', 'RAGManageræ–¹æ³•', methods);
                
                if (window.RAGManager.isJinaAIAvailable) {
                    const available = window.RAGManager.isJinaAIAvailable();
                    log(available ? 'success' : 'error', 
                        available ? 'âœ… Jina AIå¯ç”¨' : 'âŒ Jina AIä¸å¯ç”¨');
                }
            } else {
                log('error', 'âŒ RAGManageræœªåŠ è½½ï¼');
            }
            
            // 4. æµ‹è¯•ç½‘ç»œè¿æ¥
            log('info', 'æµ‹è¯•ç½‘ç»œè¿æ¥...');
            try {
                const testResponse = await fetch('https://r.jina.ai/', {
                    method: 'OPTIONS'
                });
                log('success', `âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ (status: ${testResponse.status})`);
            } catch (error) {
                log('error', `âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ${error.message}`);
            }
            
            // 5. æµ‹è¯•APIè°ƒç”¨ï¼ˆä½¿ç”¨å°æ–‡ä»¶ï¼‰
            log('info', 'å‡†å¤‡æµ‹è¯•APIè°ƒç”¨...');
            log('info', 'è¯·é€‰æ‹©ä¸€ä¸ªPDFæ–‡ä»¶è¿›è¡Œæµ‹è¯•');
            
            updateLogDisplay();
        }

        async function testPDFParse() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                log('info', `å¼€å§‹æµ‹è¯•PDFè§£æ: ${file.name}`);
                log('info', `æ–‡ä»¶å¤§å°: ${file.size} bytes (${(file.size / 1024).toFixed(2)} KB)`);
                
                if (!window.RAGManager) {
                    log('error', 'âŒ RAGManageræœªåŠ è½½ï¼');
                    return;
                }
                
                try {
                    // æ£€æŸ¥é…ç½®
                    const apiKey = window.AIAgentApp?.getJinaAIKey?.() || '';
                    log('info', `API Key: ${apiKey ? apiKey.substring(0, 30) + '...' : 'æœªé…ç½®'}`);
                    
                    // è½¬æ¢ä¸ºBase64
                    log('info', 'æ­£åœ¨è½¬æ¢ä¸ºBase64...');
                    const startTime = Date.now();
                    const base64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64String = reader.result.split(',')[1];
                            resolve(base64String);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    const base64Time = Date.now() - startTime;
                    log('success', `âœ… Base64è½¬æ¢å®Œæˆ (è€—æ—¶: ${base64Time}ms, é•¿åº¦: ${base64.length})`);
                    
                    // è°ƒç”¨è§£æ
                    log('info', 'æ­£åœ¨è°ƒç”¨Jina AI API...');
                    const parseStartTime = Date.now();
                    const content = await window.RAGManager.parsePDF(file);
                    const parseTime = Date.now() - parseStartTime;
                    
                    log('info', `è§£æå®Œæˆ (æ€»è€—æ—¶: ${parseTime}ms)`);
                    log('info', `è¿”å›å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);
                    
                    // æ£€æŸ¥ç»“æœ
                    const errorMarkers = ['[PDFæ–‡æ¡£:', '(æ³¨æ„ï¼š', 'PDFè§£æå¤±è´¥'];
                    const hasError = errorMarkers.some(m => content.includes(m));
                    
                    if (hasError || content.length < 100) {
                        log('error', 'âŒ è§£æå¤±è´¥ - è¿”å›äº†é”™è¯¯ä¿¡æ¯');
                        log('error', `å†…å®¹é¢„è§ˆ: ${content.substring(0, 500)}`);
                    } else {
                        log('success', 'âœ… PDFè§£ææˆåŠŸï¼');
                        log('info', `å†…å®¹é¢„è§ˆï¼ˆå‰500å­—ç¬¦ï¼‰:\n${content.substring(0, 500)}`);
                    }
                    
                } catch (error) {
                    log('error', `âŒ è§£æå¼‚å¸¸: ${error.message}`);
                    log('error', `é”™è¯¯å †æ ˆ: ${error.stack}`);
                }
                
                updateLogDisplay();
            };
            fileInput.click();
        }

        function clearResults() {
            logs.length = 0;
            document.getElementById('results').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.AIAgentApp && window.RAGManager) {
                    log('success', 'âœ… æ‰€æœ‰æ¨¡å—å·²åŠ è½½');
                } else {
                    log('error', 'âš ï¸ éƒ¨åˆ†æ¨¡å—æœªåŠ è½½');
                }
                updateLogDisplay();
            }, 1000);
        });
    </script>
</body>
</html>
